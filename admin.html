<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Admin Dashboard - Saint Ventura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            overflow-x: hidden;
            background: #ffffff;
        }
        .sidebar-item.active {
            background-color: #000 !important;
            color: #fff !important;
        }
        .sidebar-item {
            background-color: transparent;
            color: #000;
        }
        .sidebar-item:hover:not(.active) {
            background-color: #f3f4f6;
        }
        .sidebar-item.active:hover {
            background-color: #000 !important;
            color: #fff !important;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .main-content {
            transition: margin-left 0.3s ease;
        }
        .stock-low {
            color: #ef4444;
            font-weight: bold;
        }
        .stock-medium {
            color: #f59e0b;
        }
        .stock-high {
            color: #10b981;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 60 !important;
                transition: transform 0.3s ease;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 55 !important;
            }
            .sidebar-overlay.active {
                display: block;
            }
            .inventory-table-mobile {
                display: block;
            }
            .inventory-table-desktop {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .inventory-table-mobile {
                display: none;
            }
            .inventory-table-desktop {
                display: table;
            }
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-full bg-white text-black">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-black">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Saint Ventura</h1>
                <p class="text-gray-600">Admin Dashboard</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Login</button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white/95 backdrop-blur-md border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
            <div class="flex items-center justify-between px-4 md:px-6 py-4">
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <img src="https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1" alt="SV Logo" class="w-10 h-10 md:w-12 md:h-12 rounded-lg object-cover" onerror="this.style.display='none'">
                    <h1 class="text-xl md:text-2xl font-bold">Saint Ventura Admin</h1>
                </div>
                <button onclick="logout()" class="px-3 md:px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm md:text-base">Logout</button>
            </div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeMobileSidebar()" style="z-index: 55;"></div>

        <div class="flex pt-16">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 bg-white border-r border-gray-200 min-h-screen fixed left-0 top-16 z-40 md:z-40 shadow-lg md:shadow-none" style="z-index: 60;">
                <div class="p-4 border-b border-gray-200">
                    <button onclick="toggleSidebar()" class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-100 rounded-lg transition">
                        <span class="font-semibold sidebar-text">Menu</span>
                        <svg id="sidebar-toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15,18 9,12 15,6"></polyline>
                        </svg>
                    </button>
                </div>
                <nav class="p-4 space-y-2">
                    <a href="#" onclick="showSection('dashboard')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="dashboard">
                        <span>üìä</span>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                    <a href="#" onclick="showSection('orders')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="orders">
                        <span>üìã</span>
                        <span class="sidebar-text">Orders</span>
                    </a>
                    <a href="#" onclick="showSection('inventory')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="inventory">
                        <span>üì¶</span>
                        <span class="sidebar-text">Stock Inventory</span>
                    </a>
                    <a href="#" onclick="showSection('inbox')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition relative" data-section="inbox">
                        <span>üìß</span>
                        <span class="sidebar-text">Email Inbox</span>
                        <span id="inbox-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('broadcast')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="broadcast">
                        <span>üì¢</span>
                        <span class="sidebar-text">Broadcast</span>
                    </a>
                    <a href="#" onclick="showSection('abandoned-carts')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition relative" data-section="abandoned-carts">
                        <span>üõí</span>
                        <span class="sidebar-text">Abandoned Carts</span>
                        <span id="carts-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('fulfillers')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="fulfillers">
                        <span>üë•</span>
                        <span class="sidebar-text">Order Fulfillers</span>
                    </a>
                    <a href="#" onclick="showSection('notifications')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition relative" data-section="notifications">
                        <span>üîî</span>
                        <span class="sidebar-text">Notifications</span>
                        <span id="notifications-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('sales')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="sales">
                        <span>üí∞</span>
                        <span class="sidebar-text">Sale Dashboard</span>
                    </a>
                    <a href="#" onclick="showSection('analytics')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-section="analytics">
                        <span>üìà</span>
                        <span class="sidebar-text">Analytics</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="main-content flex-1 ml-0 md:ml-64 p-4 md:p-6 bg-white">
                <!-- Dashboard Overview Section -->
                <div id="dashboard-section" class="section">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6">Dashboard Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Total Revenue</p>
                                <span class="text-2xl">üí∞</span>
                            </div>
                            <p id="stat-total-revenue" class="text-2xl md:text-3xl font-bold">R0.00</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Total Orders</p>
                                <span class="text-2xl">üìã</span>
                            </div>
                            <p id="stat-total-orders" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Pending Orders</p>
                                <span class="text-2xl">‚è≥</span>
                            </div>
                            <p id="stat-pending-orders" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Subscribers</p>
                                <span class="text-2xl">üë•</span>
                            </div>
                            <p id="stat-subscribers" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Low Stock Items</p>
                                <span class="text-2xl">‚ö†Ô∏è</span>
                            </div>
                            <p id="stat-low-stock" class="text-2xl md:text-3xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Unread Notifications</p>
                                <span class="text-2xl">üîî</span>
                            </div>
                            <p id="stat-notifications" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Unread Emails</p>
                                <span class="text-2xl">üìß</span>
                            </div>
                            <p id="stat-emails" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-600">Abandoned Carts</p>
                                <span class="text-2xl">üõí</span>
                            </div>
                            <p id="stat-carts" class="text-2xl md:text-3xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-6 shadow-sm mb-6">
                        <h3 class="text-xl font-semibold mb-4">Recent Orders</h3>
                        <div id="recent-orders-list" class="space-y-2">
                            <div class="text-center py-8 text-gray-500">Loading recent orders...</div>
                        </div>
                    </div>
                </div>

                <!-- Orders Management Section -->
                <div id="orders-section" class="section hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 space-y-3 md:space-y-0">
                        <h2 class="text-2xl md:text-3xl font-bold">Orders Management</h2>
                        <button onclick="refreshOrders()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 flex items-center justify-center space-x-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <polyline points="1,20 1,14 7,14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4">
                                <input type="text" id="orders-search" placeholder="Search orders..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black">
                                <select id="orders-filter-status" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Order ID</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Customer</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Items</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Total</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Status</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Date</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="7" class="text-center py-12 text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="loading-spinner"></div>
                                            <span>Loading orders...</span>
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6">Analytics & Reports</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-semibold mb-4">Monthly Revenue</h3>
                            <div id="revenue-chart" class="h-64 flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p>Loading revenue data...</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                            <h3 class="text-xl font-semibold mb-4">Order Status Distribution</h3>
                            <div id="status-chart" class="h-64 flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p>Loading status data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <h3 class="text-xl font-semibold mb-4">Sales Summary</h3>
                        <div id="sales-summary" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading sales summary...</div>
                        </div>
                    </div>
                </div>

                <!-- Stock Inventory Section -->
                <div id="inventory-section" class="section hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 space-y-3 md:space-y-0">
                        <h2 class="text-2xl md:text-3xl font-bold">Stock Inventory</h2>
                        <button onclick="refreshInventory()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 flex items-center justify-center space-x-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <polyline points="1,20 1,14 7,14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200">
                        <div class="p-4 md:p-6 border-b border-gray-200">
                            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4">
                                <div class="flex-1">
                                    <input type="text" id="inventory-search" placeholder="Search products, variants..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black text-sm md:text-base">
                                </div>
                                <select id="inventory-filter-category" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                    <option value="">All Categories</option>
                                    <option value="tops">Tops</option>
                                    <option value="bottoms">Bottoms</option>
                                    <option value="accessories">Accessories</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <!-- Desktop Table -->
                            <table class="w-full inventory-table-desktop">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Product</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Variant</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Price</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Stock</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Status</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="6" class="text-center py-12 text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="loading-spinner"></div>
                                            <span>Loading inventory...</span>
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                            
                            <!-- Mobile Cards -->
                            <div id="inventory-table-mobile" class="inventory-table-mobile space-y-4 p-4">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="loading-spinner"></div>
                                        <span>Loading inventory...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Inbox Section -->
                <div id="inbox-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Email Inbox</h2>
                    <div class="bg-white rounded-lg shadow p-4 md:p-6">
                        <div class="mb-4 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4">
                            <input type="text" id="inbox-search" placeholder="Search emails..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                            <button onclick="refreshInbox()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                        </div>
                        <div id="inbox-list" class="space-y-2">
                            <div class="text-center py-8 text-gray-500">Loading emails...</div>
                        </div>
                    </div>
                </div>

                <!-- Broadcast Section -->
                <div id="broadcast-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Email Broadcast</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Subscribers</h3>
                            <div class="mb-4">
                                <p class="text-gray-600">Total Subscribers: <span id="subscriber-count" class="font-bold">0</span></p>
                            </div>
                            <div class="max-h-96 overflow-y-auto">
                                <div id="subscribers-list" class="space-y-2">
                                    <div class="text-center py-4 text-gray-500">Loading subscribers...</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Send Broadcast</h3>
                            <form id="broadcast-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Template</label>
                                    <select id="broadcast-template" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="promotion">Product Promotion</option>
                                        <option value="sale">Sale Announcement</option>
                                        <option value="new-arrival">New Arrival</option>
                                        <option value="custom">Custom Message</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Subject</label>
                                    <input type="text" id="broadcast-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Email subject">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Message</label>
                                    <textarea id="broadcast-message" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Email message"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Products (for promotion template)</label>
                                    <select id="broadcast-products" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Loading products...</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Send to All Subscribers</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Abandoned Carts Section -->
                <div id="abandoned-carts-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Abandoned Carts</h2>
                    <div class="bg-white rounded-lg shadow p-4 md:p-6">
                        <div class="mb-4 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4">
                            <button onclick="sendAbandonedCartEmails()" class="w-full md:w-auto px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm md:text-base">Send Reminder Emails</button>
                            <button onclick="refreshAbandonedCarts()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                        </div>
                        <div id="abandoned-carts-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading abandoned carts...</div>
                        </div>
                    </div>
                </div>

                <!-- Order Fulfillers Section -->
                <div id="fulfillers-section" class="section hidden">
                    <h2 class="text-3xl font-bold mb-6">Order Fulfillers</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Fulfiller List</h3>
                            <div class="mb-4">
                                <button onclick="showAddFulfillerModal()" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800">Add Fulfiller</button>
                            </div>
                            <div id="fulfillers-list" class="space-y-2">
                                <div class="text-center py-4 text-gray-500">Loading fulfillers...</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Send Order Notification</h3>
                            <form id="fulfiller-email-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Fulfiller</label>
                                    <select id="fulfiller-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Select a fulfiller...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Order Details</label>
                                    <textarea id="fulfiller-order-details" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter order details..."></textarea>
                                </div>
                                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Send Email</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div id="notifications-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Website Notifications</h2>
                    <div class="bg-white rounded-lg shadow p-4 md:p-6">
                        <div class="mb-4 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4">
                            <button onclick="markAllRead()" class="w-full md:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm md:text-base">Mark All as Read</button>
                            <button onclick="refreshNotifications()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                        </div>
                        <div id="notifications-list" class="space-y-2">
                            <div class="text-center py-8 text-gray-500">Loading notifications...</div>
                        </div>
                    </div>
                </div>

                <!-- Sale Dashboard Section -->
                <div id="sales-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Sale Dashboard (Yoco POS)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Create Order</h3>
                            <div class="mb-4">
                                <input type="text" id="pos-search" placeholder="Search products..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div id="pos-products" class="grid grid-cols-2 gap-4 mb-6">
                                <!-- Products will be loaded here -->
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">Order Items</h4>
                                <div id="pos-cart" class="space-y-2 mb-4">
                                    <p class="text-gray-500 text-sm">No items added</p>
                                </div>
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Total:</span>
                                    <span id="pos-total">R0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold mb-4">Customer Details</h3>
                            <form id="pos-order-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Customer Name</label>
                                    <input type="text" id="pos-customer-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="pos-customer-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Phone</label>
                                    <input type="tel" id="pos-customer-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Payment Method</label>
                                    <select id="pos-payment-method" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="yoco">Yoco Payment</option>
                                        <option value="cash">Cash</option>
                                        <option value="eft">EFT</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Process Order</button>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Fulfiller Modal -->
    <div id="add-fulfiller-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add Order Fulfiller</h3>
            <form id="add-fulfiller-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Name</label>
                    <input type="text" id="fulfiller-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="fulfiller-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Phone</label>
                    <input type="tel" id="fulfiller-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-black text-white py-2 rounded-lg hover:bg-gray-800">Add</button>
                    <button type="button" onclick="closeAddFulfillerModal()" class="flex-1 bg-gray-300 text-black py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'WEAR3+H3$@!N+$*';
        
        // Determine backend URL - always use production for admin dashboard
        function getBackendUrl() {
            // Always use production backend for admin
            return 'https://saint-ventura-backend.onrender.com';
        }
        
        const BACKEND_URL = getBackendUrl();
        
        console.log('Admin Dashboard - Backend URL:', BACKEND_URL);
        
        let currentSection = 'dashboard';
        let posCart = [];
        let sidebarCollapsed = false;
        
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                toggleMobileSidebar();
                return;
            }
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const icon = document.getElementById('sidebar-toggle-icon');
            
            sidebarCollapsed = !sidebarCollapsed;
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-20');
                mainContent.classList.remove('ml-64');
                mainContent.classList.add('ml-20');
                icon.style.transform = 'rotate(180deg)';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('w-20');
                sidebar.classList.add('w-64');
                mainContent.classList.remove('ml-20');
                mainContent.classList.add('ml-64');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        // Close mobile sidebar when clicking a menu item
        function showSection(section) {
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                // Remove any background color changes
                item.style.backgroundColor = '';
            });
            
            // Show selected section
            document.getElementById(`${section}-section`).classList.remove('hidden');
            const activeItem = document.querySelector(`[data-section="${section}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                // Ensure black background for active item
                activeItem.style.backgroundColor = '#000';
                activeItem.style.color = '#fff';
            }
            currentSection = section;
            
            // Load section data
            if (section === 'dashboard') loadDashboardData();
            else if (section === 'orders') loadOrders();
            else if (section === 'inventory') loadInventory();
            else if (section === 'inbox') loadInbox();
            else if (section === 'broadcast') loadBroadcast();
            else if (section === 'abandoned-carts') loadAbandonedCarts();
            else if (section === 'fulfillers') loadFulfillers();
            else if (section === 'notifications') loadNotifications();
            else if (section === 'sales') loadSales();
            else if (section === 'analytics') loadAnalytics();
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                localStorage.setItem('adminLoggedIn', 'true');
                loadDashboard();
            } else {
                document.getElementById('login-error').textContent = 'Invalid password';
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
        }


        function loadDashboard() {
            showSection('dashboard');
            loadDashboardData();
            updateBadges();
            setInterval(() => {
                updateBadges();
                if (currentSection === 'dashboard') {
                    loadDashboardData();
                }
            }, 30000); // Update every 30 seconds
        }
        
        function loadDashboardData() {
            adminFetch(`${BACKEND_URL}/api/admin/dashboard`)
                .then(data => {
                    if (data.success) {
                        // Update stats
                        document.getElementById('stat-total-revenue').textContent = `R${data.stats.totalRevenue.toFixed(2)}`;
                        document.getElementById('stat-total-orders').textContent = data.stats.totalOrders;
                        document.getElementById('stat-pending-orders').textContent = data.stats.pendingOrders;
                        document.getElementById('stat-subscribers').textContent = data.stats.totalSubscribers;
                        document.getElementById('stat-low-stock').textContent = data.stats.lowStockItems;
                        document.getElementById('stat-notifications').textContent = data.stats.unreadNotifications;
                        document.getElementById('stat-emails').textContent = data.stats.unreadEmails;
                        document.getElementById('stat-carts').textContent = data.stats.abandonedCarts;
                        
                        // Update recent orders
                        const recentList = document.getElementById('recent-orders-list');
                        if (data.recentOrders && data.recentOrders.length > 0) {
                            recentList.innerHTML = data.recentOrders.map(order => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">${order.customerName || 'Unknown'}</p>
                                            <p class="text-sm text-gray-600">${order.id || 'N/A'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold">R${(order.total || 0).toFixed(2)}</p>
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status || 'pending'}</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${order.date ? new Date(order.date).toLocaleString() : 'N/A'}</p>
                                </div>
                            `).join('');
                        } else {
                            recentList.innerHTML = '<div class="text-center py-8 text-gray-500">No recent orders</div>';
                        }
                    }
                })
                .catch(err => {
                    console.error('Error loading dashboard data:', err);
                });
        }

        function updateBadges() {
            adminFetch(`${BACKEND_URL}/api/admin/badges`)
                .then(data => {
                    if (data.inbox > 0) {
                        document.getElementById('inbox-badge').textContent = data.inbox;
                        document.getElementById('inbox-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('inbox-badge').classList.add('hidden');
                    }
                    if (data.carts > 0) {
                        document.getElementById('carts-badge').textContent = data.carts;
                        document.getElementById('carts-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('carts-badge').classList.add('hidden');
                    }
                    if (data.notifications > 0) {
                        document.getElementById('notifications-badge').textContent = data.notifications;
                        document.getElementById('notifications-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('notifications-badge').classList.add('hidden');
                    }
                })
                .catch(err => {
                    console.error('Error updating badges:', err);
                    // Silently fail for badges - don't show error to user
                });
        }

        // Helper function to add admin auth header
        function adminFetch(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['x-admin-password'] = ADMIN_PASSWORD;
            options.headers['Content-Type'] = 'application/json';
            
            // Add credentials for CORS
            options.credentials = 'omit';
            options.mode = 'cors';
            
            console.log('Fetching:', url, 'with headers:', options.headers);
            
            return fetch(url, options)
                .then(response => {
                    console.log('Response status:', response.status, 'for URL:', url);
                    if (!response.ok) {
                        return response.text().then(text => {
                            let errorData;
                            try {
                                errorData = JSON.parse(text);
                            } catch {
                                errorData = { error: text || `HTTP ${response.status} ${response.statusText}` };
                            }
                            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .catch(err => {
                    console.error('Fetch error for', url, ':', err);
                    if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                        throw new Error('Cannot connect to server. Please check your internet connection and ensure the backend is running.');
                    }
                    throw err;
                });
        }
        
        // Error handling helper
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error-message">${message}</div>`;
            }
        }

        // Inventory functions
        let allInventoryData = [];
        
        function loadInventory() {
            const tbody = document.getElementById('inventory-table');
            const mobileContainer = document.getElementById('inventory-table-mobile');
            
            // Show loading state
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading inventory...</span></div></td></tr>';
            }
            if (mobileContainer) {
                mobileContainer.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading inventory...</span></div></div>';
            }
            
            adminFetch(`${BACKEND_URL}/api/admin/inventory`)
                .then(data => {
                    console.log('Inventory data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format received - expected array');
                    }
                    allInventoryData = data;
                    renderInventory(data);
                })
                .catch(err => {
                    console.error('Inventory loading error:', err);
                    const errorMsg = `Error loading inventory: ${err.message}. Please check your connection and ensure the backend is running at ${BACKEND_URL}`;
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12"><div class="error-message">${errorMsg}<br><small>Backend URL: ${BACKEND_URL}</small></div></td></tr>`;
                    }
                    if (mobileContainer) {
                        mobileContainer.innerHTML = `<div class="error-message">${errorMsg}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                    }
                });
        }
        
        function renderInventory(data) {
            const tbody = document.getElementById('inventory-table');
            const mobileContainer = document.getElementById('inventory-table-mobile');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-gray-500">No products found</td></tr>';
                if (mobileContainer) mobileContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No products found</div>';
                return;
            }
            
            // Desktop table
            tbody.innerHTML = data.map(item => {
                const stockClass = item.stock === 0 ? 'stock-low' : item.stock < 5 ? 'stock-medium' : 'stock-high';
                const stockStatus = item.stock === 0 ? 'Out of Stock' : item.stock < 5 ? 'Low Stock' : 'In Stock';
                const productImage = item.image || 'https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1';
                
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="py-4 px-4 md:px-6">
                            <div class="flex items-center space-x-3 md:space-x-4">
                                <img src="${productImage}" alt="${item.productName || item.name}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-lg border border-gray-200" onerror="this.src='https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1'">
                                <div>
                                    <p class="font-semibold text-gray-900 text-sm md:text-base">${item.productName || item.name}</p>
                                    <p class="text-xs md:text-sm text-gray-500">${item.category || 'N/A'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 md:px-3 py-1 bg-gray-100 rounded-full text-xs md:text-sm font-medium">${item.variant || 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-semibold text-sm md:text-base">R${(item.price || 0).toFixed(2)}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <input type="number" value="${item.stock}" data-id="${item.id}" data-product-id="${item.productId}" data-variant="${item.variantId || ''}" 
                                class="w-20 md:w-24 px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black font-semibold text-sm ${stockClass}" 
                                min="0" onchange="updateStockInput(this)">
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 md:px-3 py-1 rounded-full text-xs font-semibold ${item.stock === 0 ? 'bg-red-100 text-red-800' : item.stock < 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${stockStatus}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <button onclick="saveStock('${item.id}', '${item.productId}', '${item.variantId || ''}')" 
                                class="px-3 md:px-4 py-1 md:py-2 bg-black text-white rounded-lg text-xs md:text-sm font-medium hover:bg-gray-800 transition">Save</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Mobile cards
            if (mobileContainer) {
                mobileContainer.innerHTML = data.map(item => {
                    const stockClass = item.stock === 0 ? 'stock-low' : item.stock < 5 ? 'stock-medium' : 'stock-high';
                    const stockStatus = item.stock === 0 ? 'Out of Stock' : item.stock < 5 ? 'Low Stock' : 'In Stock';
                    const productImage = item.image || 'https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1';
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                            <div class="flex items-start space-x-4 mb-4">
                                <img src="${productImage}" alt="${item.productName || item.name}" class="w-20 h-20 object-cover rounded-lg border border-gray-200" onerror="this.src='https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1'">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900 mb-1">${item.productName || item.name}</p>
                                    <p class="text-xs text-gray-500 mb-2">${item.category || 'N/A'}</p>
                                    <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium">${item.variant || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Price:</span>
                                    <span class="font-semibold">R${(item.price || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Stock:</span>
                                    <input type="number" value="${item.stock}" data-id="${item.id}" data-product-id="${item.productId}" data-variant="${item.variantId || ''}" 
                                        class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black font-semibold text-sm ${stockClass}" 
                                        min="0" onchange="updateStockInput(this)">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Status:</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${item.stock === 0 ? 'bg-red-100 text-red-800' : item.stock < 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${stockStatus}</span>
                                </div>
                                <button onclick="saveStock('${item.id}', '${item.productId}', '${item.variantId || ''}')" 
                                    class="w-full px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition">Save Stock</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function updateStockInput(input) {
            // Visual feedback when stock is updated
            input.classList.add('ring-2', 'ring-black');
            setTimeout(() => {
                input.classList.remove('ring-2', 'ring-black');
            }, 500);
        }
        
        // Search and filter functionality
        document.getElementById('inventory-search')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const category = document.getElementById('inventory-filter-category')?.value || '';
            filterInventory(searchTerm, category);
        });
        
        document.getElementById('inventory-filter-category')?.addEventListener('change', (e) => {
            const searchTerm = document.getElementById('inventory-search')?.value.toLowerCase() || '';
            filterInventory(searchTerm, e.target.value);
        });
        
        function filterInventory(searchTerm, category) {
            let filtered = allInventoryData;
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.productName || item.name).toLowerCase().includes(searchTerm) ||
                    (item.variant || '').toLowerCase().includes(searchTerm) ||
                    (item.category || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (category) {
                filtered = filtered.filter(item => (item.category || '').toLowerCase() === category.toLowerCase());
            }
            
            renderInventory(filtered);
        }

        function updateStock(input) {
            // Stock value updated, will be saved when Save is clicked
        }

        function saveStock(itemId, productId, variantId) {
            const input = document.querySelector(`input[data-id="${itemId}"]`);
            const stock = parseInt(input.value);
            
            if (isNaN(stock) || stock < 0) {
                alert('Please enter a valid stock number');
                return;
            }
            
            adminFetch(`${BACKEND_URL}/api/admin/inventory/update`, {
                method: 'POST',
                body: JSON.stringify({ productId, variantId, stock })
            })
            .then(data => {
                if (data.success) {
                    // Show success notification
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Saved!';
                    button.classList.add('bg-green-600');
                    button.classList.remove('bg-black');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600');
                        button.classList.add('bg-black');
                    }, 2000);
                    loadInventory();
                } else {
                    alert('Error updating stock: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error updating stock:', err);
                alert('Error updating stock: ' + err.message);
            });
        }

        function refreshInventory() {
            loadInventory();
        }

        // Inbox functions
        function loadInbox() {
            const list = document.getElementById('inbox-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading emails...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/inbox`)
                .then(data => {
                    console.log('Inbox data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No emails</div>';
                        return;
                    }
                    list.innerHTML = data.map(email => `
                        <div class="border border-gray-200 rounded-lg p-4 ${email.read ? 'bg-gray-50' : 'bg-white'}">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-semibold">${email.from || email.name || 'Unknown'}</p>
                                    <p class="text-sm text-gray-600">${email.subject || 'No subject'}</p>
                                </div>
                                <span class="text-xs text-gray-500">${new Date(email.date).toLocaleString()}</span>
                            </div>
                            <p class="text-sm text-gray-700">${(email.body || email.message || '').substring(0, 200)}...</p>
                            ${!email.read ? `<button onclick="markEmailRead('${email.id}')" class="mt-2 text-sm text-blue-600 hover:underline">Mark as Read</button>` : ''}
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Inbox loading error:', err);
                    list.innerHTML = `<div class="error-message">Error loading emails: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function markEmailRead(emailId) {
            adminFetch(`${BACKEND_URL}/api/admin/inbox/read`, {
                method: 'POST',
                body: JSON.stringify({ emailId })
            })
            .then(data => {
                if (data.success) {
                    loadInbox();
                    updateBadges();
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark email as read'));
                }
            })
            .catch(err => {
                console.error('Error marking email as read:', err);
                alert('Error: ' + err.message);
            });
        }

        function refreshInbox() {
            loadInbox();
        }

        // Broadcast functions
        function loadBroadcast() {
            // Load subscribers
            adminFetch(`${BACKEND_URL}/api/admin/subscribers`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid subscribers data format');
                    }
                    document.getElementById('subscriber-count').textContent = data.length;
                    const list = document.getElementById('subscribers-list');
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-4 text-gray-500">No subscribers</div>';
                        return;
                    }
                    list.innerHTML = data.map(sub => `
                        <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                            <span class="text-sm">${sub.email}</span>
                            <span class="text-xs text-gray-500">${new Date(sub.date).toLocaleDateString()}</span>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading subscribers:', err);
                    document.getElementById('subscribers-list').innerHTML = 
                        `<div class="error-message">Error loading subscribers: ${err.message}</div>`;
                });

            // Load products
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid products data format');
                    }
                    const select = document.getElementById('broadcast-products');
                    if (select) {
                        select.innerHTML = '<option value="">Select products...</option>' +
                            data.map(p => `<option value="${p.id}">${p.name} - R${(p.price || 0).toFixed(2)}</option>`).join('');
                    }
                })
                .catch(err => {
                    console.error('Error loading products:', err);
                    const select = document.getElementById('broadcast-products');
                    if (select) {
                        select.innerHTML = `<option value="">Error loading products</option>`;
                    }
                });
        }

        document.getElementById('broadcast-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            const template = document.getElementById('broadcast-template').value;
            const subject = document.getElementById('broadcast-subject').value;
            const message = document.getElementById('broadcast-message').value;
            const products = Array.from(document.getElementById('broadcast-products').selectedOptions).map(o => o.value);

            if (!subject || !message) {
                alert('Please fill in subject and message');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            adminFetch(`${BACKEND_URL}/api/admin/broadcast`, {
                method: 'POST',
                body: JSON.stringify({ template, subject, message, products })
            })
            .then(data => {
                console.log('Broadcast response:', data);
                if (data.success) {
                    alert(`Email sent to ${data.sent || 0} subscribers${data.total ? ` out of ${data.total}` : ''}`);
                    document.getElementById('broadcast-form').reset();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Broadcast error:', err);
                alert('Error sending broadcast: ' + err.message);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });

        // Abandoned carts functions
        function loadAbandonedCarts() {
            const list = document.getElementById('abandoned-carts-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading abandoned carts...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts`)
                .then(data => {
                    console.log('Abandoned carts data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No abandoned carts</div>';
                        return;
                    }
                    list.innerHTML = data.map(cart => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-semibold">${cart.email || 'Guest'}</p>
                                    <p class="text-sm text-gray-600">${(cart.items || []).length} items</p>
                                </div>
                                <span class="text-xs text-gray-500">${cart.date ? new Date(cart.date).toLocaleString() : 'N/A'}</span>
                            </div>
                            <p class="text-sm font-semibold">Total: R${(cart.total || 0).toFixed(2)}</p>
                            ${cart.email ? `<button onclick="sendCartReminder('${cart.id}')" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">Send Reminder</button>` : ''}
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading abandoned carts:', err);
                    list.innerHTML = `<div class="error-message">Error loading abandoned carts: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function sendCartReminder(cartId) {
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts/remind`, {
                method: 'POST',
                body: JSON.stringify({ cartId })
            })
            .then(data => {
                if (data.success) {
                    alert('Reminder email sent');
                    loadAbandonedCarts();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send reminder'));
                }
            })
            .catch(err => {
                console.error('Error sending reminder:', err);
                alert('Error: ' + err.message);
            });
        }

        function sendAbandonedCartEmails() {
            if (!confirm('Send reminder emails to all customers with abandoned carts?')) return;
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts/remind-all`, {
                method: 'POST'
            })
            .then(data => {
                if (data.success) {
                    alert(`Reminder emails sent to ${data.sent || 0} customers`);
                    loadAbandonedCarts();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send reminders'));
                }
            })
            .catch(err => {
                console.error('Error sending reminders:', err);
                alert('Error: ' + err.message);
            });
        }

        function refreshAbandonedCarts() {
            loadAbandonedCarts();
        }

        // Fulfillers functions
        function loadFulfillers() {
            const list = document.getElementById('fulfillers-list');
            const select = document.getElementById('fulfiller-select');
            list.innerHTML = '<div class="text-center py-4 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading fulfillers...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/fulfillers`)
                .then(data => {
                    console.log('Fulfillers data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-4 text-gray-500">No fulfillers added</div>';
                        select.innerHTML = '<option value="">No fulfillers available</option>';
                        return;
                    }
                    list.innerHTML = data.map(f => `
                        <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                            <div>
                                <p class="font-semibold">${f.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-600">${f.email || 'No email'}</p>
                            </div>
                            <button onclick="deleteFulfiller('${f.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">Delete</button>
                        </div>
                    `).join('');
                    select.innerHTML = '<option value="">Select a fulfiller...</option>' +
                        data.map(f => `<option value="${f.id}">${f.name || 'Unknown'} (${f.email || 'No email'})</option>`).join('');
                })
                .catch(err => {
                    console.error('Error loading fulfillers:', err);
                    list.innerHTML = `<div class="error-message">Error loading fulfillers: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                    select.innerHTML = '<option value="">Error loading fulfillers</option>';
                });
        }

        function showAddFulfillerModal() {
            document.getElementById('add-fulfiller-modal').classList.remove('hidden');
        }

        function closeAddFulfillerModal() {
            document.getElementById('add-fulfiller-modal').classList.add('hidden');
            document.getElementById('add-fulfiller-form').reset();
        }

        document.getElementById('add-fulfiller-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('fulfiller-name').value;
            const email = document.getElementById('fulfiller-email').value;
            const phone = document.getElementById('fulfiller-phone').value;

            adminFetch(`${BACKEND_URL}/api/admin/fulfillers`, {
                method: 'POST',
                body: JSON.stringify({ name, email, phone })
            })
            .then(data => {
                if (data.success) {
                    closeAddFulfillerModal();
                    loadFulfillers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to add fulfiller'));
                }
            })
            .catch(err => {
                console.error('Error adding fulfiller:', err);
                alert('Error: ' + err.message);
            });
        });

        function deleteFulfiller(id) {
            if (!confirm('Delete this fulfiller?')) return;
            adminFetch(`${BACKEND_URL}/api/admin/fulfillers/${id}`, {
                method: 'DELETE'
            })
            .then(data => {
                if (data.success) {
                    loadFulfillers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete fulfiller'));
                }
            })
            .catch(err => {
                console.error('Error deleting fulfiller:', err);
                alert('Error: ' + err.message);
            });
        }

        document.getElementById('fulfiller-email-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const fulfillerId = document.getElementById('fulfiller-select').value;
            const orderDetails = document.getElementById('fulfiller-order-details').value;

            if (!fulfillerId || !orderDetails) {
                alert('Please select a fulfiller and enter order details');
                return;
            }

            adminFetch(`${BACKEND_URL}/api/admin/fulfillers/notify`, {
                method: 'POST',
                body: JSON.stringify({ fulfillerId, orderDetails })
            })
            .then(data => {
                if (data.success) {
                    alert('Email sent to fulfiller');
                    document.getElementById('fulfiller-email-form').reset();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send email'));
                }
            })
            .catch(err => {
                console.error('Error sending fulfiller email:', err);
                alert('Error: ' + err.message);
            });
        });

        // Notifications functions
        function loadNotifications() {
            const list = document.getElementById('notifications-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading notifications...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/notifications`)
                .then(data => {
                    console.log('Notifications data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No notifications</div>';
                        return;
                    }
                    list.innerHTML = data.map(notif => `
                        <div class="border border-gray-200 rounded-lg p-4 ${notif.read ? 'bg-gray-50' : 'bg-white'}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold">${notif.title || 'Notification'}</p>
                                    <p class="text-sm text-gray-600">${notif.message || 'No message'}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-500">${notif.date ? new Date(notif.date).toLocaleString() : 'N/A'}</span>
                                    ${!notif.read ? '<button onclick="markNotificationRead(\'' + notif.id + '\')" class="ml-2 text-sm text-blue-600 hover:underline">Mark Read</button>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading notifications:', err);
                    list.innerHTML = `<div class="error-message">Error loading notifications: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function markNotificationRead(notifId) {
            adminFetch(`${BACKEND_URL}/api/admin/notifications/read`, {
                method: 'POST',
                body: JSON.stringify({ notificationId: notifId })
            })
            .then(data => {
                if (data.success) {
                    loadNotifications();
                    updateBadges();
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark notification as read'));
                }
            })
            .catch(err => {
                console.error('Error marking notification as read:', err);
                alert('Error: ' + err.message);
            });
        }

        function markAllRead() {
            adminFetch(`${BACKEND_URL}/api/admin/notifications/read-all`, {
                method: 'POST'
            })
            .then(data => {
                if (data.success) {
                    loadNotifications();
                    updateBadges();
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark all as read'));
                }
            })
            .catch(err => {
                console.error('Error marking all as read:', err);
                alert('Error: ' + err.message);
            });
        }

        function refreshNotifications() {
            loadNotifications();
        }

        // Orders Management functions
        let allOrdersData = [];
        
        function loadOrders() {
            const tbody = document.getElementById('orders-table');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading orders...</span></div></td></tr>';
            }
            
            adminFetch(`${BACKEND_URL}/api/admin/orders`)
                .then(data => {
                    console.log('Orders data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    allOrdersData = data;
                    renderOrders(data);
                })
                .catch(err => {
                    console.error('Error loading orders:', err);
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-12"><div class="error-message">Error loading orders: ${err.message}</div></td></tr>`;
                    }
                });
        }
        
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table');
            if (!tbody) return;
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-500">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const itemCount = Array.isArray(order.items) ? order.items.length : 0;
                const statusClass = order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-mono text-sm">${order.id || 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <div>
                                <p class="font-semibold">${order.customerName || 'Unknown'}</p>
                                <p class="text-xs text-gray-500">${order.customerEmail || ''}</p>
                            </div>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${itemCount} items</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-semibold">R${(order.total || 0).toFixed(2)}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${order.status || 'pending'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="text-sm text-gray-600">${order.date ? new Date(order.date).toLocaleDateString() : 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <select onchange="updateOrderStatus('${order.id}', this.value)" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateOrderStatus(orderId, status) {
            adminFetch(`${BACKEND_URL}/api/admin/orders/${orderId}/status`, {
                method: 'PUT',
                body: JSON.stringify({ status })
            })
            .then(data => {
                if (data.success) {
                    loadOrders();
                    if (currentSection === 'dashboard') loadDashboardData();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update order status'));
                }
            })
            .catch(err => {
                console.error('Error updating order status:', err);
                alert('Error: ' + err.message);
            });
        }
        
        function refreshOrders() {
            loadOrders();
        }
        
        // Search and filter orders
        document.getElementById('orders-search')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const status = document.getElementById('orders-filter-status')?.value || '';
            filterOrders(searchTerm, status);
        });
        
        document.getElementById('orders-filter-status')?.addEventListener('change', (e) => {
            const searchTerm = document.getElementById('orders-search')?.value.toLowerCase() || '';
            filterOrders(searchTerm, e.target.value);
        });
        
        function filterOrders(searchTerm, status) {
            let filtered = allOrdersData;
            
            if (searchTerm) {
                filtered = filtered.filter(order => 
                    (order.customerName || '').toLowerCase().includes(searchTerm) ||
                    (order.customerEmail || '').toLowerCase().includes(searchTerm) ||
                    (order.id || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (status) {
                filtered = filtered.filter(order => (order.status || '') === status);
            }
            
            renderOrders(filtered);
        }

        // Analytics functions
        function loadAnalytics() {
            adminFetch(`${BACKEND_URL}/api/admin/dashboard`)
                .then(data => {
                    if (data.success) {
                        // Render revenue chart
                        renderRevenueChart(data.monthlyRevenue);
                        // Render status chart
                        renderStatusChart(data.stats);
                        // Render sales summary
                        renderSalesSummary(data);
                    }
                })
                .catch(err => {
                    console.error('Error loading analytics:', err);
                    document.getElementById('revenue-chart').innerHTML = `<div class="error-message">Error loading analytics: ${err.message}</div>`;
                });
        }
        
        function renderRevenueChart(monthlyRevenue) {
            const container = document.getElementById('revenue-chart');
            if (!container) return;
            
            const months = Object.keys(monthlyRevenue).sort();
            const values = months.map(m => monthlyRevenue[m]);
            const maxValue = Math.max(...values, 1);
            
            container.innerHTML = `
                <div class="w-full h-full flex items-end justify-between space-x-2">
                    ${months.map((month, i) => {
                        const height = (values[i] / maxValue) * 100;
                        const monthLabel = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short' });
                        return `
                            <div class="flex-1 flex flex-col items-center">
                                <div class="w-full bg-gray-200 rounded-t" style="height: ${height}%; min-height: 20px;">
                                    <div class="w-full h-full bg-black rounded-t transition-all duration-300"></div>
                                </div>
                                <p class="text-xs text-gray-600 mt-2">${monthLabel}</p>
                                <p class="text-xs font-semibold mt-1">R${values[i].toFixed(0)}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderStatusChart(stats) {
            const container = document.getElementById('status-chart');
            if (!container) return;
            
            const total = stats.totalOrders || 1;
            const completedPercent = ((stats.completedOrders || 0) / total) * 100;
            const pendingPercent = ((stats.pendingOrders || 0) / total) * 100;
            
            container.innerHTML = `
                <div class="w-full space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Completed</span>
                            <span class="text-sm font-semibold">${stats.completedOrders || 0} (${completedPercent.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: ${completedPercent}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Pending</span>
                            <span class="text-sm font-semibold">${stats.pendingOrders || 0} (${pendingPercent.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-yellow-600 h-4 rounded-full transition-all duration-300" style="width: ${pendingPercent}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSalesSummary(data) {
            const container = document.getElementById('sales-summary');
            if (!container) return;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Total Revenue</p>
                        <p class="text-2xl font-bold">R${(data.stats.totalRevenue || 0).toFixed(2)}</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Average Order Value</p>
                        <p class="text-2xl font-bold">R${data.stats.totalOrders > 0 ? (data.stats.totalRevenue / data.stats.totalOrders).toFixed(2) : '0.00'}</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Completion Rate</p>
                        <p class="text-2xl font-bold">${data.stats.totalOrders > 0 ? ((data.stats.completedOrders / data.stats.totalOrders) * 100).toFixed(1) : '0'}%</p>
                    </div>
                </div>
            `;
        }

        // Sales/POS functions
        function loadSales() {
            const container = document.getElementById('pos-products');
            container.innerHTML = '<div class="col-span-2 text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading products...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(data => {
                    console.log('POS products data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid products data format');
                    }
                    if (data.length === 0) {
                        container.innerHTML = '<div class="col-span-2 text-center py-8 text-gray-500">No products available</div>';
                        return;
                    }
                    container.innerHTML = data.map(p => `
                        <div class="border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition" onclick="addToPOSCart(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price || 0})">
                            <p class="font-semibold text-sm md:text-base">${p.name || 'Unknown Product'}</p>
                            <p class="text-gray-600 text-sm md:text-base">R${(p.price || 0).toFixed(2)}</p>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading POS products:', err);
                    container.innerHTML = `<div class="col-span-2 error-message">Error loading products: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function addToPOSCart(id, name, price) {
            const existing = posCart.find(item => item.id === id);
            if (existing) {
                existing.quantity++;
            } else {
                posCart.push({ id, name, price, quantity: 1 });
            }
            updatePOSCart();
        }

        function updatePOSCart() {
            const container = document.getElementById('pos-cart');
            if (posCart.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No items added</p>';
                document.getElementById('pos-total').textContent = 'R0.00';
                return;
            }
            container.innerHTML = posCart.map(item => `
                <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-600">R${item.price.toFixed(2)} √ó ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updatePOSQuantity(${item.id}, -1)" class="px-2 py-1 bg-gray-200 rounded">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updatePOSQuantity(${item.id}, 1)" class="px-2 py-1 bg-gray-200 rounded">+</button>
                        <button onclick="removeFromPOSCart(${item.id})" class="ml-2 px-2 py-1 bg-red-500 text-white rounded text-sm">Remove</button>
                    </div>
                </div>
            `).join('');
            const total = posCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('pos-total').textContent = 'R' + total.toFixed(2);
        }

        function updatePOSQuantity(id, change) {
            const item = posCart.find(i => i.id === id);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    posCart = posCart.filter(i => i.id !== id);
                }
                updatePOSCart();
            }
        }

        function removeFromPOSCart(id) {
            posCart = posCart.filter(item => item.id !== id);
            updatePOSCart();
        }

        document.getElementById('pos-order-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (posCart.length === 0) {
                alert('Please add items to cart');
                return;
            }
            const customerName = document.getElementById('pos-customer-name').value;
            const customerEmail = document.getElementById('pos-customer-email').value;
            const customerPhone = document.getElementById('pos-customer-phone').value;
            const paymentMethod = document.getElementById('pos-payment-method').value;
            const total = posCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            adminFetch(`${BACKEND_URL}/api/admin/pos/order`, {
                method: 'POST',
                body: JSON.stringify({
                    customerName,
                    customerEmail,
                    customerPhone,
                    paymentMethod,
                    items: posCart,
                    total
                })
            })
            .then(data => {
                console.log('POS order response:', data);
                if (data.success) {
                    alert('Order created successfully');
                    posCart = [];
                    updatePOSCart();
                    document.getElementById('pos-order-form').reset();
                    if (paymentMethod === 'yoco' && data.paymentUrl) {
                        window.open(data.paymentUrl, '_blank');
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to create order'));
                }
            })
            .catch(err => {
                console.error('Error creating POS order:', err);
                alert('Error creating order: ' + err.message);
            });
        });
    </script>
</body>
</html>

