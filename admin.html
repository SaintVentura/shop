<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Saint Ventura</title>
    <link rel="icon" type="image/png" href="https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            box-sizing: border-box;
            overflow-x: hidden;
            background: #ffffff;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        * {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-item {
            background-color: transparent;
            color: #000;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-item.active {
            background-color: transparent !important;
            color: #000 !important;
            border: 2px solid #000 !important;
            font-weight: 600;
        }
        .sidebar-item:hover:not(.active) {
            background-color: #f9fafb;
            transform: translateX(2px);
        }
        .sidebar-item.active:hover {
            background-color: transparent !important;
            color: #000 !important;
            border: 2px solid #000 !important;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .main-content {
            transition: margin-left 0.3s ease;
        }
        .stock-low {
            color: #ef4444;
            font-weight: bold;
        }
        .stock-medium {
            color: #f59e0b;
        }
        .stock-high {
            color: #10b981;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 60 !important;
                transition: transform 0.3s ease;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 55 !important;
            }
            .sidebar-overlay.active {
                display: block;
            }
            .inventory-table-mobile {
                display: block;
            }
            .inventory-table-desktop {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .inventory-table-mobile {
                display: none;
            }
            .inventory-table-desktop {
                display: block;
            }
            .orders-table-mobile {
                display: none;
            }
            .orders-table-desktop {
                display: table;
            }
        }
        
        @media (max-width: 768px) {
            .inventory-table-desktop {
                display: none;
            }
            .inventory-table-mobile {
                display: block;
            }
            .orders-table-mobile {
                display: block;
            }
            .orders-table-desktop {
                display: none;
            }
        }
        
        .product-group {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .product-group:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .product-header {
            background: #f9fafb;
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
        }
        
        .product-header:hover {
            background: #f3f4f6;
        }
        
        .product-header.expanded {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .product-variants {
            display: none;
            background: #ffffff;
        }
        
        .product-variants.show {
            display: block;
        }
        
        .variant-row {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }
        
        .variant-row:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .variant-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-full bg-white text-black">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-black">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Saint Ventura</h1>
                <p class="text-gray-600">Admin Dashboard</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Login</button>
                <p id="login-error" class="text-red-500 text-sm text-center hidden"></p>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white/95 backdrop-blur-md border-b border-gray-200 fixed top-0 left-0 right-0 z-[70]" style="z-index: 70 !important;">
            <div class="flex items-center justify-between px-4 md:px-6 py-4">
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button onclick="toggleMobileSidebar()" class="md:hidden p-2 hover:bg-gray-100 rounded-lg" aria-label="Toggle mobile sidebar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <img src="https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1" alt="SV Logo" class="w-10 h-10 md:w-12 md:h-12 rounded-lg object-cover" onerror="this.style.display='none'">
                    <h1 class="text-xl md:text-2xl font-bold">Saint Ventura Admin</h1>
                </div>
                <button onclick="logout()" class="px-3 md:px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm md:text-base">Logout</button>
            </div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeMobileSidebar()" style="z-index: 55;"></div>

        <div class="flex pt-16">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 bg-white border-r border-gray-200 min-h-screen fixed left-0 top-16 z-40 md:z-40 shadow-lg md:shadow-none" style="z-index: 60;">
                <div class="pt-6 pb-2 px-4">
                    <button onclick="toggleSidebar()" class="w-full flex items-center justify-between px-4 py-2 hover:bg-gray-100 rounded-lg transition" aria-label="Toggle sidebar">
                        <span class="font-semibold sidebar-text text-lg">Menu</span>
                        <svg id="sidebar-toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15,18 9,12 15,6"></polyline>
                        </svg>
                    </button>
                </div>
                <nav class="px-4 pb-4 space-y-0 -mt-1">
                    <a href="#" onclick="showSection('dashboard')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="dashboard">
                        <span>üìä</span>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                    <a href="#" onclick="showSection('orders')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="orders">
                        <span>üìã</span>
                        <span class="sidebar-text">Orders</span>
                    </a>
                    <a href="#" onclick="showSection('inventory')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="inventory">
                        <span>üì¶</span>
                        <span class="sidebar-text">Stock Inventory</span>
                    </a>
                    <a href="#" onclick="showSection('inbox')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition relative" data-section="inbox">
                        <span>üìß</span>
                        <span class="sidebar-text">Email Inbox</span>
                        <span id="inbox-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('broadcast')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="broadcast">
                        <span>üì¢</span>
                        <span class="sidebar-text">Broadcast</span>
                    </a>
                    <a href="#" onclick="showSection('abandoned-carts')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition relative" data-section="abandoned-carts">
                        <span>üõí</span>
                        <span class="sidebar-text">Abandoned Carts</span>
                        <span id="carts-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('fulfillers')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="fulfillers">
                        <span>üë•</span>
                        <span class="sidebar-text">Order Fulfillers</span>
                    </a>
                    <a href="#" onclick="showSection('notifications')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition relative" data-section="notifications">
                        <span>üîî</span>
                        <span class="sidebar-text">Notifications</span>
                        <span id="notifications-badge" class="notification-badge hidden">0</span>
                    </a>
                    <a href="#" onclick="showSection('sales')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="sales">
                        <span>üí∞</span>
                        <span class="sidebar-text">Sale Dashboard</span>
                    </a>
                    <a href="#" onclick="showSection('analytics')" class="sidebar-item flex items-center space-x-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition" data-section="analytics">
                        <span>üìà</span>
                        <span class="sidebar-text">Analytics</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="main-content flex-1 ml-0 md:ml-64 p-6 md:p-8 lg:p-10 bg-white">
                <!-- Dashboard Overview Section -->
                <div id="dashboard-section" class="section">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Dashboard Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-8">
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Total Revenue</p>
                                <span class="text-2xl md:text-3xl">üí∞</span>
                            </div>
                            <p id="stat-total-revenue" class="text-2xl md:text-3xl font-bold text-black">R0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Total Profit</p>
                                <span class="text-2xl md:text-3xl">üìà</span>
                            </div>
                            <p id="stat-total-profit" class="text-2xl md:text-3xl font-bold text-green-600">R0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Completed Orders</p>
                                <span class="text-2xl md:text-3xl">üìã</span>
                            </div>
                            <p id="stat-total-orders" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Pending Orders</p>
                                <span class="text-2xl md:text-3xl">‚è≥</span>
                            </div>
                            <p id="stat-pending-orders" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-8">
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Subscribers</p>
                                <span class="text-2xl md:text-3xl">üë•</span>
                            </div>
                            <p id="stat-subscribers" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Low Stock Items</p>
                                <span class="text-2xl md:text-3xl">‚ö†Ô∏è</span>
                            </div>
                            <p id="stat-low-stock" class="text-2xl md:text-3xl font-bold text-red-600">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Unread Notifications</p>
                                <span class="text-2xl md:text-3xl">üîî</span>
                            </div>
                            <p id="stat-notifications" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Unread Emails</p>
                                <span class="text-2xl md:text-3xl">üìß</span>
                            </div>
                            <p id="stat-emails" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-8">
                        <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm md:text-base text-gray-600 font-medium">Abandoned Carts</p>
                                <span class="text-2xl md:text-3xl">üõí</span>
                            </div>
                            <p id="stat-carts" class="text-2xl md:text-3xl font-bold text-black">0</p>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-8 shadow-sm mt-8">
                        <h3 class="text-xl md:text-2xl font-semibold mb-6">Recent Orders</h3>
                        <div id="recent-orders-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading recent orders...</div>
                        </div>
                    </div>
                </div>

                <!-- Orders Management Section -->
                <div id="orders-section" class="section hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
                        <h2 class="text-2xl md:text-3xl font-bold">Orders Management</h2>
                        <button onclick="refreshOrders()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 flex items-center justify-center space-x-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <polyline points="1,20 1,14 7,14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-6">
                                <label for="orders-search" class="sr-only">Search orders</label>
                                <input type="text" id="orders-search" name="orders-search" placeholder="Search orders..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black" aria-label="Search orders">
                                <label for="orders-filter-status" class="sr-only">Filter by status</label>
                                <select id="orders-filter-status" name="orders-filter-status" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg" aria-label="Filter orders by status">
                                    <option value="">All Status</option>
                                    <option value="pending checkout">Pending Checkout</option>
                                    <option value="pending fulfillment">Pending Fulfillment</option>
                                    <option value="fulfilled">Fulfilled</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <!-- Desktop Table -->
                            <table class="w-full orders-table-desktop">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Order ID</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Customer</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Items</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Total</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Delivery Cost</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Status</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Date</th>
                                        <th class="text-left py-4 px-4 md:px-6 font-semibold text-gray-700 text-sm md:text-base">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="8" class="text-center py-12 text-gray-500">
                                        <div class="flex items-center justify-center space-x-2">
                                            <div class="loading-spinner"></div>
                                            <span>Loading orders...</span>
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                            
                            <!-- Mobile Cards -->
                            <div id="orders-table-mobile" class="orders-table-mobile space-y-6 p-6">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="loading-spinner"></div>
                                        <span>Loading orders...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Analytics & Reports</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-8 shadow-sm">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Monthly Revenue</h3>
                            <div id="revenue-chart" class="h-64 flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p>Loading revenue data...</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-8 shadow-sm">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Order Status Distribution</h3>
                            <div id="status-chart" class="h-64 flex items-center justify-center text-gray-500">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p>Loading status data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-6 md:p-8 shadow-sm">
                        <h3 class="text-xl md:text-2xl font-semibold mb-6">Sales Summary</h3>
                        <div id="sales-summary" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading sales summary...</div>
                        </div>
                    </div>
                </div>

                <!-- Stock Inventory Section -->
                <div id="inventory-section" class="section hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
                        <h2 class="text-2xl md:text-3xl font-bold">Stock Inventory</h2>
                        <button onclick="refreshInventory()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 flex items-center justify-center space-x-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <polyline points="1,20 1,14 7,14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200">
                        <div class="p-6 md:p-8 border-b border-gray-200">
                            <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-6">
                                <div class="flex-1">
                                    <label for="inventory-search" class="sr-only">Search products and variants</label>
                                    <input type="text" id="inventory-search" name="inventory-search" placeholder="Search products, variants..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black text-sm md:text-base" aria-label="Search products and variants">
                                </div>
                                <select id="inventory-filter-category" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                                    <option value="">All Categories</option>
                                    <option value="tops">Tops</option>
                                    <option value="bottoms">Bottoms</option>
                                    <option value="accessories">Accessories</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-6">
                            <!-- Desktop Product Tree -->
                            <div id="inventory-table" class="inventory-table-desktop space-y-4">
                                <div class="text-center py-12 text-gray-500">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="loading-spinner"></div>
                                        <span>Loading inventory...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile Product Tree -->
                            <div id="inventory-table-mobile" class="inventory-table-mobile space-y-4">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="loading-spinner"></div>
                                        <span>Loading inventory...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Inbox Section -->
                <div id="inbox-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Email Inbox</h2>
                    <div class="bg-white rounded-lg shadow p-6 md:p-8">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-6">
                            <input type="text" id="inbox-search" placeholder="Search emails..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm md:text-base">
                            <div class="flex space-x-2">
                                <button onclick="showComposeEmail()" class="w-full md:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm md:text-base font-medium">Compose</button>
                                <button onclick="fetchEmails()" class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm md:text-base">Fetch Emails</button>
                                <button onclick="refreshInbox()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                            </div>
                        </div>
                        <div id="inbox-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading emails...</div>
                        </div>
                    </div>
                </div>

                <!-- Broadcast Section -->
                <div id="broadcast-section" class="section hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">Email Broadcast</h2>
                        <p class="text-gray-600">Send newsletters, promotions, and updates to all subscribers</p>
                            </div>
                    <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-100 p-6 md:p-8 mb-8">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6">
                                <div>
                                <h3 class="text-xl md:text-2xl font-semibold mb-2">Subscriber Overview</h3>
                                <p class="text-gray-600">Total Subscribers: <span id="subscriber-count" class="font-bold text-black text-lg">0</span></p>
                                </div>
                            <button onclick="openBroadcastEmailComposer()" class="mt-4 md:mt-0 w-full md:w-auto px-6 py-3 bg-black text-white rounded-xl font-semibold hover:bg-gray-800 transition shadow-md hover:shadow-lg">
                                ‚úâÔ∏è Compose Broadcast Email
                            </button>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-4 max-h-96 overflow-y-auto mb-4">
                            <div id="subscribers-list" class="space-y-2">
                                <div class="text-center py-4 text-gray-500">Loading subscribers...</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-4">
                            <h4 class="text-lg font-semibold mb-4">Add New Subscriber</h4>
                            <form id="add-subscriber-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email Address</label>
                                    <input type="email" id="new-subscriber-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required placeholder="subscriber@example.com">
                                </div>
                                <button type="submit" class="w-full px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 font-medium">Add Subscriber</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Abandoned Carts Section -->
                <div id="abandoned-carts-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Abandoned Carts</h2>
                    <div class="bg-white rounded-lg shadow p-6 md:p-8">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-6">
                            <button onclick="openAbandonedCartEmailComposer()" class="w-full md:w-auto px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm md:text-base">Compose Reminder Email</button>
                            <button onclick="refreshAbandonedCarts()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                        </div>
                        <div id="abandoned-carts-list" class="space-y-6">
                            <div class="text-center py-8 text-gray-500">Loading abandoned carts...</div>
                        </div>
                    </div>
                </div>

                <!-- Order Fulfillers Section -->
                <div id="fulfillers-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Order Fulfillers</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white rounded-lg shadow p-6 md:p-8">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Fulfiller List</h3>
                            <div class="mb-6">
                                <button onclick="showAddFulfillerModal()" class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 font-medium">Add Fulfiller</button>
                            </div>
                            <div id="fulfillers-list" class="space-y-4">
                                <div class="text-center py-4 text-gray-500">Loading fulfillers...</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 md:p-8">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Send Order Notification</h3>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Fulfiller</label>
                                    <select id="fulfiller-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Select a fulfiller...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Order (Pending Fulfillment or Fulfilled)</label>
                                    <select id="fulfiller-order-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Select an order...</option>
                                    </select>
                                </div>
                                <button onclick="openFulfillerEmailComposer()" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Compose Email to Fulfiller</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div id="notifications-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Website Notifications</h2>
                    <div class="bg-white rounded-lg shadow p-6 md:p-8">
                        <div class="mb-6 flex flex-col md:flex-row justify-between items-stretch md:items-center space-y-4 md:space-y-0 md:space-x-6">
                            <button onclick="markAllRead()" class="w-full md:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm md:text-base">Mark All as Read</button>
                            <button onclick="refreshNotifications()" class="w-full md:w-auto px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800 text-sm md:text-base">Refresh</button>
                        </div>
                        <div id="notifications-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Loading notifications...</div>
                        </div>
                    </div>
                </div>

                <!-- Sale Dashboard Section -->
                <div id="sales-section" class="section hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8">Point of Sale</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white rounded-lg shadow p-6 md:p-8">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Create Order</h3>
                            <div class="mb-6">
                                <label for="pos-search" class="sr-only">Search products</label>
                                <input type="text" id="pos-search" name="pos-search" placeholder="Search products..." class="w-full px-4 py-2 border border-gray-300 rounded-lg" aria-label="Search products">
                            </div>
                            <div id="pos-products" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                                <!-- Products will be loaded here -->
                            </div>
                            <div class="border-t pt-6">
                                <h4 class="font-semibold text-lg mb-4">Order Items</h4>
                                <div id="pos-cart" class="space-y-4 mb-6">
                                    <p class="text-gray-500 text-sm">No items added</p>
                                </div>
                                <div class="flex justify-between font-bold text-lg">
                                    <span>Total:</span>
                                    <span id="pos-total">R0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 md:p-8">
                            <h3 class="text-xl md:text-2xl font-semibold mb-6">Customer Details</h3>
                            <form id="pos-order-form" class="space-y-6">
                                <div>
                                    <label for="pos-customer-name" class="block text-sm font-medium mb-2">Customer Name</label>
                                    <input type="text" id="pos-customer-name" name="pos-customer-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required aria-label="Customer name">
                                </div>
                                <div>
                                    <label for="pos-customer-email" class="block text-sm font-medium mb-2">Email</label>
                                    <input type="email" id="pos-customer-email" name="pos-customer-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required aria-label="Customer email">
                                </div>
                                <div>
                                    <label for="pos-customer-phone" class="block text-sm font-medium mb-2">Phone</label>
                                    <input type="tel" id="pos-customer-phone" name="pos-customer-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required aria-label="Customer phone">
                                </div>
                                <div>
                                    <label for="pos-payment-method" class="block text-sm font-medium mb-2">Payment Method</label>
                                    <select id="pos-payment-method" name="pos-payment-method" class="w-full px-4 py-2 border border-gray-300 rounded-lg" aria-label="Payment method">
                                        <option value="yoco">Yoco Payment</option>
                                        <option value="cash">Cash</option>
                                        <option value="eft">EFT</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition">Process Order</button>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Compose Email Modal -->
    <div id="compose-email-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4" style="padding-top: 2rem;">
        <div class="bg-white rounded-lg p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto shadow-2xl" style="margin-top: 0;">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-4 border-b">
                <h3 class="text-xl font-semibold">Compose Email</h3>
                <button onclick="closeComposeEmail()" class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close compose email">&times;</button>
            </div>
            <form id="compose-email-form" class="space-y-4">
                <!-- Email Template Selection -->
                <div id="email-template-section" class="hidden">
                    <label class="block text-sm font-medium mb-2">Email Template</label>
                    <select id="email-template-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black" onchange="loadEmailTemplate()">
                        <option value="">Select a template...</option>
                        <optgroup label="Broadcast Templates">
                            <option value="promotion">Promotion / Sale</option>
                            <option value="new-product">New Product Launch</option>
                            <option value="news">News / Update</option>
                        </optgroup>
                        <optgroup label="Fulfiller Templates">
                            <option value="fulfiller-order">Completed Order Notification</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">To <span class="text-gray-500 text-xs">(comma-separated for multiple)</span></label>
                        <label for="compose-to" class="block text-sm font-medium mb-2">To</label>
                        <textarea id="compose-to" name="compose-to" class="w-full px-4 py-2 border border-gray-300 rounded-lg min-h-[60px] resize-y" required placeholder="recipient@example.com or recipient1@example.com, recipient2@example.com" aria-label="Email recipients"></textarea>
                        <button type="button" onclick="addAllSubscribers()" id="add-subscribers-btn" class="hidden mt-2 text-xs text-blue-600 hover:text-blue-800 underline">Add All Subscribers</button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Subject</label>
                        <label for="compose-subject" class="block text-sm font-medium mb-2">Subject</label>
                        <input type="text" id="compose-subject" name="compose-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required placeholder="Email subject" aria-label="Email subject">
                    </div>
                </div>
                
                <!-- Email Builder Toolbar -->
                <div class="border border-gray-300 rounded-lg p-3 bg-gray-50">
                    <p class="text-sm font-medium mb-2">Add Section:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="addEmailSection('text')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Text</button>
                        <button type="button" onclick="addEmailSection('heading')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Heading</button>
                        <button type="button" onclick="addEmailSection('image')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Image</button>
                        <button type="button" onclick="addEmailSection('button')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Button</button>
                        <button type="button" onclick="addEmailSection('divider')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Divider</button>
                        <button type="button" onclick="addEmailSection('spacer')" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm hover:bg-gray-100">Spacer</button>
                    </div>
                </div>
                
                <!-- Email Builder Canvas -->
                <div>
                    <label class="block text-sm font-medium mb-2">Email Content</label>
                    <div id="email-builder" class="border border-gray-300 rounded-lg p-4 min-h-[400px] bg-white space-y-4">
                        <div class="email-section" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500">Text Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="3" placeholder="Enter text content..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Toggle -->
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="preview-mode" onchange="toggleEmailPreview()" class="rounded">
                    <label for="preview-mode" class="text-sm">Preview Mode</label>
                </div>
                
                <div class="flex space-x-2 sticky bottom-0 bg-white pt-4 border-t">
                    <button type="submit" class="flex-1 bg-black text-white py-2 rounded-lg hover:bg-gray-800 font-medium">Send</button>
                    <button type="button" onclick="closeComposeEmail()" class="flex-1 bg-gray-300 text-black py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View/Reply Email Modal -->
    <div id="view-email-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4" style="padding-top: 2rem;">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl" style="margin-top: 0;">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-4 border-b">
                <h3 class="text-xl font-semibold" id="view-email-subject">Email</h3>
                <button onclick="closeViewEmail()" class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Close email view">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-600">From: <span id="view-email-from" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">Date: <span id="view-email-date" class="font-medium"></span></p>
                </div>
                <div class="border-t pt-4">
                    <div id="view-email-body" class="email-content-container"></div>
                </div>
                <div class="flex space-x-2 pt-4 border-t sticky bottom-0 bg-white">
                    <button onclick="replyToEmail()" class="flex-1 bg-black text-white py-2 rounded-lg hover:bg-gray-800 font-medium">Reply</button>
                    <button onclick="deleteEmail()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-medium">Delete</button>
                    <button onclick="closeViewEmail()" class="flex-1 bg-gray-300 text-black py-2 rounded-lg hover:bg-gray-400">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Fulfiller Modal -->
    <div id="add-fulfiller-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add Order Fulfiller</h3>
            <form id="add-fulfiller-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Name</label>
                    <input type="text" id="fulfiller-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="fulfiller-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Phone</label>
                    <input type="tel" id="fulfiller-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-black text-white py-2 rounded-lg hover:bg-gray-800">Add</button>
                    <button type="button" onclick="closeAddFulfillerModal()" class="flex-1 bg-gray-300 text-black py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'WEAR3+H3$@!N+$*';
        
        // Initialize data arrays and variables at the top level to avoid initialization errors
        let allInventoryData = [];
        let allOrdersData = [];
        let currentViewingEmail = null;
        let emailBuilderSections = null; // Store sections when entering preview
        
        // Define showAddFulfillerModal IMMEDIATELY at the top to ensure it's available globally
        // Define it both on window and as a global function for maximum compatibility
        function showAddFulfillerModal() {
            console.log('showAddFulfillerModal called');
            const modal = document.getElementById('add-fulfiller-modal');
            if (modal) {
                console.log('Modal found, opening...');
                modal.classList.remove('hidden');
                // Clear form fields
                const nameInput = document.getElementById('fulfiller-name');
                const emailInput = document.getElementById('fulfiller-email');
                const phoneInput = document.getElementById('fulfiller-phone');
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
                if (phoneInput) phoneInput.value = '';
                // Re-setup form listener when modal is opened
                setTimeout(() => {
                    console.log('Re-setting up fulfiller form...');
                    if (typeof setupFulfillerForm === 'function') {
                        setupFulfillerForm();
                    }
                }, 100);
            } else {
                console.error('Add fulfiller modal not found');
                alert('Error: Add fulfiller modal not found. Please refresh the page.');
            }
        }
        // Also assign to window for explicit global access
        window.showAddFulfillerModal = showAddFulfillerModal;
        
        // Also define closeAddFulfillerModal early
        function closeAddFulfillerModal() {
            const modal = document.getElementById('add-fulfiller-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            const form = document.getElementById('add-fulfiller-form');
            if (form) {
                form.reset();
            }
        }
        // Also assign to window for explicit global access
        window.closeAddFulfillerModal = closeAddFulfillerModal;
        
        // Auto-detect backend URL based on environment (same as index.html)
        function getBackendUrl() {
            const hostname = window.location.hostname;
            const origin = window.location.origin;
            
            console.log('Admin Dashboard - Detecting backend URL for hostname:', hostname, 'origin:', origin);
            
            // Local development
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '' || hostname === '0.0.0.0') {
                console.log('Using localhost backend');
                return 'http://localhost:3000';
            }
            
            // GitHub Pages (production)
            // Backend deployed on Render
            const PRODUCTION_BACKEND_URL = 'https://saint-ventura-backend.onrender.com';
            
            // If you're on GitHub Pages, use production backend
            if (hostname.includes('github.io') || hostname.includes('github.com') || origin.includes('github.io') || origin.includes('github.com')) {
                console.log('Detected GitHub Pages, using production backend:', PRODUCTION_BACKEND_URL);
                return PRODUCTION_BACKEND_URL;
            }
            
            // Default to production for any other domain
            console.log('Using production backend:', PRODUCTION_BACKEND_URL);
            return PRODUCTION_BACKEND_URL;
        }
        
        const BACKEND_URL = getBackendUrl();
        
        console.log('Admin Dashboard - Backend URL:', BACKEND_URL);
        
        let currentSection = 'dashboard';
        let posCart = [];
        let sidebarCollapsed = false;
        
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                toggleMobileSidebar();
                return;
            }
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const icon = document.getElementById('sidebar-toggle-icon');
            
            sidebarCollapsed = !sidebarCollapsed;
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-20');
                mainContent.classList.remove('ml-64');
                mainContent.classList.add('ml-20');
                icon.style.transform = 'rotate(180deg)';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('w-20');
                sidebar.classList.add('w-64');
                mainContent.classList.remove('ml-20');
                mainContent.classList.add('ml-64');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        // Close mobile sidebar when clicking a menu item
        function showSection(section) {
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            // Remove active class and border from ALL sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                // Remove all inline styles to reset to default
                item.style.backgroundColor = '';
                item.style.color = '';
                item.style.border = '';
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${section}-section`);
            if (!targetSection) {
                console.error(`Section not found: ${section}-section`);
                return;
            }
            targetSection.classList.remove('hidden');
            const activeItem = document.querySelector(`[data-section="${section}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                // Ensure black border for active item, black text
                activeItem.style.backgroundColor = 'transparent';
                activeItem.style.color = '#000';
                activeItem.style.border = '2px solid #000';
            }
            currentSection = section;
            
            // Load section data
            try {
                if (section === 'dashboard') {
                    loadDashboardData();
                } else if (section === 'orders') {
                    loadOrders();
                } else if (section === 'inventory') {
                    loadInventory();
                } else if (section === 'inbox') {
                    loadInbox();
                } else if (section === 'broadcast') {
                    loadBroadcast();
                } else if (section === 'abandoned-carts') {
                    loadAbandonedCarts();
                } else if (section === 'fulfillers') {
                    loadFulfillers();
                    // Set up the Add Fulfiller button when section is shown
                    setTimeout(() => {
                        if (typeof setupAddFulfillerButton === 'function') {
                            setupAddFulfillerButton();
                        }
                    }, 100);
                } else if (section === 'notifications') {
                    loadNotifications();
                } else if (section === 'sales') {
                    loadSales();
                } else if (section === 'analytics') {
                    loadAnalytics();
                }
            } catch (error) {
                console.error(`Error loading section ${section}:`, error);
            }
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                localStorage.setItem('adminLoggedIn', 'true');
                loadDashboard();
                // Start real-time sync immediately after login
                startRealTimeSync();
            } else {
                document.getElementById('login-error').textContent = 'Invalid password';
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadDashboard();
            // Start real-time sync immediately when logged in
            startRealTimeSync();
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            // Stop real-time sync when logging out
            stopRealTimeSync();
        }


        // Real-time sync for all admin users
        let syncInterval = null;
        let badgeInterval = null; // Separate interval for badges (updates more frequently)
        
        function startRealTimeSync() {
            // Clear existing intervals if any
            if (syncInterval) clearInterval(syncInterval);
            if (badgeInterval) clearInterval(badgeInterval);
            
            // Update badges more frequently (every 10 seconds) - works across all tabs
            badgeInterval = setInterval(() => {
                // Only update if page is visible (optimize for background tabs)
                if (!document.hidden) {
                    updateBadges();
                }
            }, 10000); // Update badges every 10 seconds
            
            // Sync section data less frequently (every 30 seconds)
            syncInterval = setInterval(() => {
                // Only sync if page is visible
                if (document.hidden) {
                    return; // Skip if tab is in background
                }
                
                // Update badges (also update here as backup)
                updateBadges();
                
                // Refresh current section data
                if (currentSection === 'dashboard') {
                    loadDashboardData();
                } else if (currentSection === 'orders') {
                    loadOrders();
                } else if (currentSection === 'inventory') {
                    loadInventory();
                } else if (currentSection === 'inbox') {
                    // Refresh inbox immediately when on inbox page
                    loadInbox();
                    // Auto-fetch new emails every 2 minutes when on inbox page
                    const now = Date.now();
                    if (!window.lastEmailFetch || (now - window.lastEmailFetch) > 120000) {
                        adminFetch(`${BACKEND_URL}/api/admin/inbox/fetch`, {
                            method: 'POST'
                        })
                        .then(data => {
                            if (data.success && data.new > 0) {
                                loadInbox();
                                updateBadges();
                            }
                        })
                        .catch(err => console.error('Auto-fetch error:', err));
                        window.lastEmailFetch = now;
                    }
                } else if (currentSection === 'broadcast') {
                    loadBroadcast();
                } else if (currentSection === 'fulfillers') {
                    loadFulfillers();
                } else if (currentSection === 'notifications') {
                    // Refresh notifications immediately when on notifications page
                    loadNotifications();
                }
            }, 30000); // Update section data every 30 seconds
        }
        
        function stopRealTimeSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            if (badgeInterval) {
                clearInterval(badgeInterval);
                badgeInterval = null;
            }
        }
        
        // Handle page visibility changes - update badges immediately when tab becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Tab became visible - update badges immediately
                updateBadges();
            }
        });
        
        function loadDashboard() {
            showSection('dashboard');
            loadDashboardData();
            updateBadges();
            // Don't restart sync here - it's already running from login
            // Just ensure it's running
            if (!syncInterval && !badgeInterval) {
                startRealTimeSync();
            }
        }
        
        function loadDashboardData() {
            adminFetch(`${BACKEND_URL}/api/admin/dashboard`)
                .then(data => {
                    if (data.success) {
                        // Update stats
                        document.getElementById('stat-total-revenue').textContent = `R${data.stats.totalRevenue.toFixed(2)}`;
                        document.getElementById('stat-total-profit').textContent = `R${(data.stats.totalProfit || 0).toFixed(2)}`;
                        document.getElementById('stat-total-orders').textContent = data.stats.completedOrders;
                        document.getElementById('stat-pending-orders').textContent = data.stats.pendingOrders;
                        document.getElementById('stat-subscribers').textContent = data.stats.totalSubscribers;
                        document.getElementById('stat-low-stock').textContent = data.stats.lowStockItems;
                        document.getElementById('stat-notifications').textContent = data.stats.unreadNotifications;
                        document.getElementById('stat-emails').textContent = data.stats.unreadEmails;
                        document.getElementById('stat-carts').textContent = data.stats.abandonedCarts;
                        
                        // Update recent orders
                        const recentList = document.getElementById('recent-orders-list');
                        if (data.recentOrders && data.recentOrders.length > 0) {
                            recentList.innerHTML = data.recentOrders.map(order => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold">${order.customerName || 'Unknown'}</p>
                                            <p class="text-sm text-gray-600">${order.id || 'N/A'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold">R${(order.total || 0).toFixed(2)}</p>
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${order.status === 'fulfilled' ? 'bg-green-100 text-green-800' : order.status === 'pending fulfillment' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${order.status || 'pending checkout'}</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${order.date ? new Date(order.date).toLocaleString() : 'N/A'}</p>
                                </div>
                            `).join('');
                        } else {
                            recentList.innerHTML = '<div class="text-center py-8 text-gray-500">No recent orders</div>';
                        }
                    }
                })
                .catch(err => {
                    console.error('Error loading dashboard data:', err);
                });
        }

        // Store previous badge counts to detect changes
        let previousBadgeCounts = {
            inbox: 0,
            carts: 0,
            notifications: 0
        };
        
        function updateBadges() {
            adminFetch(`${BACKEND_URL}/api/admin/badges`)
                .then(data => {
                    // Check if counts changed and refresh sections if needed
                    if (data.inbox !== previousBadgeCounts.inbox && currentSection === 'inbox') {
                        loadInbox(); // Refresh inbox if count changed
                    }
                    if (data.notifications !== previousBadgeCounts.notifications && currentSection === 'notifications') {
                        loadNotifications(); // Refresh notifications if count changed
                    }
                    if (data.carts !== previousBadgeCounts.carts && currentSection === 'abandoned-carts') {
                        loadAbandonedCarts(); // Refresh abandoned carts if count changed
                    }
                    
                    // Update previous counts
                    previousBadgeCounts = {
                        inbox: data.inbox || 0,
                        carts: data.carts || 0,
                        notifications: data.notifications || 0
                    };
                    
                    // Update badge displays
                    if (data.inbox > 0) {
                        document.getElementById('inbox-badge').textContent = data.inbox;
                        document.getElementById('inbox-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('inbox-badge').classList.add('hidden');
                    }
                    if (data.carts > 0) {
                        document.getElementById('carts-badge').textContent = data.carts;
                        document.getElementById('carts-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('carts-badge').classList.add('hidden');
                    }
                    if (data.notifications > 0) {
                        document.getElementById('notifications-badge').textContent = data.notifications;
                        document.getElementById('notifications-badge').classList.remove('hidden');
                    } else {
                        document.getElementById('notifications-badge').classList.add('hidden');
                    }
                })
                .catch(err => {
                    console.error('Error updating badges:', err);
                    // Silently fail for badges - don't show error to user
                });
        }

        // Helper function to add admin auth header
        function adminFetch(url, options = {}) {
            // Ensure options object exists
            if (!options) options = {};
            if (!options.headers) options.headers = {};
            
            // Set required headers
            options.headers['x-admin-password'] = ADMIN_PASSWORD;
            options.headers['Content-Type'] = 'application/json';
            options.headers['Accept'] = 'application/json';
            
            // CORS settings
            options.credentials = 'omit';
            options.mode = 'cors';
            options.cache = 'no-cache';
            
            console.log('Admin Fetch:', url);
            console.log('Method:', options.method || 'GET');
            console.log('Headers:', Object.keys(options.headers));
            
            return fetch(url, options)
                .then(async response => {
                    console.log('Response status:', response.status, response.statusText, 'for URL:', url);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    // Check if response is ok
                    if (!response.ok) {
                        // Try to parse error response
                        const text = await response.text();
                        console.error('Error response text:', text);
                        let errorData;
                        try {
                            errorData = JSON.parse(text);
                        } catch {
                            errorData = { error: text || `HTTP ${response.status} ${response.statusText}` };
                        }
                        const errorMsg = errorData.error || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
                        throw new Error(errorMsg);
                    }
                    
                    // Check content type
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const jsonData = await response.json();
                        console.log('Successfully parsed JSON response');
                        return jsonData;
                    } else {
                        // If not JSON, return text
                        const text = await response.text();
                        console.warn('Non-JSON response received:', text.substring(0, 100));
                        try {
                            return JSON.parse(text);
                        } catch {
                            throw new Error('Invalid JSON response from server');
                        }
                    }
                })
                .catch(err => {
                    console.error('Fetch error for', url, ':', err);
                    console.error('Error details:', {
                        message: err.message,
                        stack: err.stack,
                        name: err.name
                    });
                    
                    if (err.message.includes('Failed to fetch') || 
                        err.message.includes('NetworkError') || 
                        err.message.includes('Network request failed') ||
                        err.message.includes('Load failed')) {
                        throw new Error(`Cannot connect to server at ${BACKEND_URL}. Please check your internet connection and ensure the backend is running.`);
                    }
                    if (err.message.includes('CORS') || err.message.includes('CORS policy')) {
                        throw new Error(`CORS error: The backend at ${BACKEND_URL} may not be allowing requests from this origin.`);
                    }
                    if (err.message.includes('401') || err.message.includes('Unauthorized')) {
                        throw new Error('Authentication failed. Please check your admin password.');
                    }
                    throw err;
                });
        }
        
        // Error handling helper
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error-message">${message}</div>`;
            }
        }

        // Inventory functions
        // allInventoryData is declared at the top of the script
        
        function loadInventory() {
            const tbody = document.getElementById('inventory-table');
            const mobileContainer = document.getElementById('inventory-table-mobile');
            
            // Show loading state
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading inventory...</span></div></td></tr>';
            }
            if (mobileContainer) {
                mobileContainer.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading inventory...</span></div></div>';
            }
            
            adminFetch(`${BACKEND_URL}/api/admin/inventory`)
                .then(data => {
                    console.log('Inventory data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format received - expected array');
                    }
                    allInventoryData = data;
                    renderInventory(data);
                })
                .catch(err => {
                    console.error('Inventory loading error:', err);
                    const errorMsg = `Error loading inventory: ${err.message}. Please check your connection and ensure the backend is running at ${BACKEND_URL}`;
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12"><div class="error-message">${errorMsg}<br><small>Backend URL: ${BACKEND_URL}</small></div></td></tr>`;
                    }
                    if (mobileContainer) {
                        mobileContainer.innerHTML = `<div class="error-message">${errorMsg}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                    }
                });
        }
        
        function renderInventory(data) {
            const desktopContainer = document.getElementById('inventory-table');
            const mobileContainer = document.getElementById('inventory-table-mobile');
            
            if (data.length === 0) {
                if (desktopContainer) desktopContainer.innerHTML = '<div class="text-center py-12 text-gray-500">No products found</div>';
                if (mobileContainer) mobileContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No products found</div>';
                return;
            }
            
            // Group inventory by product
            const productGroups = {};
            data.forEach(item => {
                const productId = item.productId || item.id.split('-')[0];
                if (!productGroups[productId]) {
                    productGroups[productId] = {
                        productId: productId,
                        productName: item.productName || item.name,
                        category: item.category,
                        price: item.price,
                        image: item.image || item.productImage,
                        variants: []
                    };
                }
                productGroups[productId].variants.push(item);
            });
            
            // Render desktop view
            if (desktopContainer) {
                desktopContainer.innerHTML = Object.values(productGroups).map((product, index) => {
                    const productId = product.productId;
                    const totalStock = product.variants.reduce((sum, v) => sum + (parseInt(v.stock) || 0), 0);
                    const totalStockCost = product.variants.reduce((sum, v) => sum + (parseFloat(v.stockCost) || 0), 0);
                    const totalCostPerUnit = totalStock > 0 ? (totalStockCost / totalStock) : 0;
                    const lowStockCount = product.variants.filter(v => (parseInt(v.stock) || 0) < 5).length;
                    const outOfStockCount = product.variants.filter(v => (parseInt(v.stock) || 0) === 0).length;
                    
                    // Define productIdEscaped in outer scope so it's available for the save button
                    const productIdEscaped = String(product.productId || '').replace(/'/g, "\\'");
                    
                    const variantsHtml = product.variants.map(variant => {
                        const stockClass = variant.stock === 0 ? 'stock-low' : variant.stock < 5 ? 'stock-medium' : 'stock-high';
                        const stockStatus = variant.stock === 0 ? 'Out of Stock' : variant.stock < 5 ? 'Low Stock' : 'In Stock';
                        const variantId = String(variant.id || '').replace(/'/g, "\\'");
                        const variantIdEscaped = String(variant.variantId || '').replace(/'/g, "\\'");
                        
                        return `
                            <div class="variant-row">
                                <div>
                                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm font-medium">${variant.variant || 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="font-semibold text-sm">R${(variant.price || product.price || 0).toFixed(2)}</span>
                                </div>
                                <div>
                                    <label for="stock-${variantIdEscaped}" class="sr-only">Stock for ${variant.variant || 'variant'}</label>
                                    <input type="number" id="stock-${variantIdEscaped}" name="stock-${variantIdEscaped}" value="${variant.stock}" data-id="${variantId}" data-product-id="${productIdEscaped}" data-variant="${variantIdEscaped}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black font-semibold text-sm ${stockClass}" 
                                        min="0" onchange="updateStockInput(this)" aria-label="Stock quantity for ${variant.variant || 'variant'}">
                                </div>
                                <div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${variant.stock === 0 ? 'bg-red-100 text-red-800' : variant.stock < 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${stockStatus}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    const productImage = product.image || 'https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1';
                    const productNameEscaped = String(product.productName || '').replace(/'/g, "\\'");
                    
                    return `
                        <div class="product-group">
                            <div class="product-header" onclick="toggleProduct('product-${productId}')" id="header-product-${productId}">
                                <div class="flex items-center space-x-4 flex-1">
                                    <img src="${productImage}" alt="${product.productName}" class="w-16 h-16 object-cover rounded-lg border border-gray-200" onerror="this.src='https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1'">
                                    <div class="flex-1">
                                        <p class="font-semibold text-lg">${product.productName}</p>
                                        <div class="flex items-center space-x-2 md:space-x-4 mt-1 flex-wrap">
                                            <p class="text-xs md:text-sm text-gray-500">${product.category || 'N/A'}</p>
                                            <p class="text-xs md:text-sm font-semibold">R${(product.price || 0).toFixed(2)}</p>
                                            <span class="text-xs md:text-sm text-gray-600">${product.variants.length} variant${product.variants.length !== 1 ? 's' : ''}</span>
                                            <span class="text-xs md:text-sm font-semibold">Total Stock: ${totalStock}</span>
                                            <span class="text-xs md:text-sm font-semibold text-blue-600">Stock Cost: R${totalStockCost.toFixed(2)}</span>
                                            <span class="text-xs md:text-sm font-semibold text-purple-600">Cost/Unit: R${totalCostPerUnit.toFixed(2)}</span>
                                            ${lowStockCount > 0 ? `<span class="text-xs md:text-sm text-yellow-600">‚ö†Ô∏è ${lowStockCount} low stock</span>` : ''}
                                            ${outOfStockCount > 0 ? `<span class="text-xs md:text-sm text-red-600">‚ùå ${outOfStockCount} out of stock</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <svg class="expand-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"></polyline>
                                </svg>
                            </div>
                            <div class="product-variants" id="product-${productId}">
                                <div class="p-4 bg-gray-50 border-b border-gray-200">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; align-items: center;" class="text-sm font-semibold text-gray-700">
                                        <div>Variant</div>
                                        <div>Price</div>
                                        <div>Stock</div>
                                        <div>Status</div>
                                    </div>
                                </div>
                                ${variantsHtml}
                                <div class="p-4 bg-gray-50 border-t border-gray-200">
                                    <button onclick="saveAllVariants('${productIdEscaped}', this)" 
                                        class="w-full px-6 py-3 bg-black text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition shadow-md hover:shadow-lg"
                                        aria-label="Save all changes for ${product.productName}">
                                        Save All Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render mobile view
            if (mobileContainer) {
                mobileContainer.innerHTML = Object.values(productGroups).map((product) => {
                    const productId = product.productId;
                    const totalStock = product.variants.reduce((sum, v) => sum + (parseInt(v.stock) || 0), 0);
                    const totalStockCost = product.variants.reduce((sum, v) => sum + (parseFloat(v.stockCost) || 0), 0);
                    const totalCostPerUnit = totalStock > 0 ? (totalStockCost / totalStock) : 0;
                    
                    const variantsHtml = product.variants.map(variant => {
                        const stockClass = variant.stock === 0 ? 'stock-low' : variant.stock < 5 ? 'stock-medium' : 'stock-high';
                        const stockStatus = variant.stock === 0 ? 'Out of Stock' : variant.stock < 5 ? 'Low Stock' : 'In Stock';
                        const variantId = String(variant.id || '').replace(/'/g, "\\'");
                        const productIdEscaped = String(variant.productId || '').replace(/'/g, "\\'");
                        const variantIdEscaped = String(variant.variantId || '').replace(/'/g, "\\'");
                        
                        return `
                            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="px-3 py-1 bg-gray-100 rounded-full text-sm font-medium">${variant.variant || 'N/A'}</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${variant.stock === 0 ? 'bg-red-100 text-red-800' : variant.stock < 5 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${stockStatus}</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Price:</span>
                                        <span class="font-semibold">R${(variant.price || product.price || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Stock:</span>
                                        <label for="mobile-stock-${variantIdEscaped}" class="sr-only">Stock for ${variant.variant || 'variant'}</label>
                                        <input type="number" id="mobile-stock-${variantIdEscaped}" name="mobile-stock-${variantIdEscaped}" value="${variant.stock}" data-id="${variantId}" data-product-id="${productIdEscaped}" data-variant="${variantIdEscaped}" 
                                            class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-black font-semibold text-sm ${stockClass}" 
                                            min="0" onchange="updateStockInput(this)" aria-label="Stock quantity for ${variant.variant || 'variant'}">
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    const productImage = product.image || 'https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1';
                    const productIdEscapedMobile = String(product.productId || '').replace(/'/g, "\\'");
                    
                    return `
                        <div class="product-group">
                            <div class="product-header" onclick="toggleProduct('mobile-product-${productId}')" id="mobile-header-product-${productId}">
                                <div class="flex items-center space-x-4 flex-1">
                                    <img src="${productImage}" alt="${product.productName}" class="w-16 h-16 object-cover rounded-lg border border-gray-200" onerror="this.src='https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1'">
                                    <div class="flex-1">
                                        <p class="font-semibold text-base">${product.productName}</p>
                                        <p class="text-xs text-gray-500 mt-1">${product.category || 'N/A'} ‚Ä¢ ${product.variants.length} variants ‚Ä¢ Stock: ${totalStock} ‚Ä¢ Stock Cost: R${totalStockCost.toFixed(2)} ‚Ä¢ Cost/Unit: R${totalCostPerUnit.toFixed(2)}</p>
                                    </div>
                                </div>
                                <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"></polyline>
                                </svg>
                            </div>
                            <div class="product-variants space-y-3 p-4" id="mobile-product-${productId}">
                                ${variantsHtml}
                                <button onclick="saveAllVariants('${productIdEscapedMobile}', this)" 
                                    class="w-full px-6 py-3 bg-black text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition shadow-md hover:shadow-lg mt-4"
                                    aria-label="Save all changes for ${product.productName}">
                                    Save All Changes
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function toggleProduct(productId) {
            const variantsDiv = document.getElementById(productId);
            const headerId = productId.includes('mobile-') ? `mobile-header-${productId.replace('mobile-', '')}` : `header-${productId}`;
            const header = document.getElementById(headerId);
            const icon = header?.querySelector('.expand-icon');
            
            if (variantsDiv) {
                variantsDiv.classList.toggle('show');
                header?.classList.toggle('expanded');
                if (icon) {
                    icon.classList.toggle('expanded');
                }
            }
        }
        
        function updateStockInput(input) {
            // Visual feedback when stock is updated
            input.classList.add('ring-2', 'ring-black');
            setTimeout(() => {
                input.classList.remove('ring-2', 'ring-black');
            }, 500);
        }
        
        // Search and filter functionality
        document.getElementById('inventory-search')?.addEventListener('input', (e) => {
            // Only filter if data is loaded
            if (allInventoryData && allInventoryData.length > 0) {
            const searchTerm = e.target.value.toLowerCase();
            const category = document.getElementById('inventory-filter-category')?.value || '';
            filterInventory(searchTerm, category);
            }
        });
        
        document.getElementById('inventory-filter-category')?.addEventListener('change', (e) => {
            // Only filter if data is loaded
            if (allInventoryData && allInventoryData.length > 0) {
            const searchTerm = document.getElementById('inventory-search')?.value.toLowerCase() || '';
            filterInventory(searchTerm, e.target.value);
            }
        });
        
        function filterInventory(searchTerm, category) {
            // Ensure allInventoryData is initialized
            if (!allInventoryData || !Array.isArray(allInventoryData)) {
                allInventoryData = [];
            }
            
            let filtered = [...allInventoryData]; // Create a copy to avoid mutation
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    (item.productName || item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.variant || '').toLowerCase().includes(searchTerm) ||
                    (item.category || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (category) {
                filtered = filtered.filter(item => (item.category || '').toLowerCase() === category.toLowerCase());
            }
            
            renderInventory(filtered);
        }

        function updateStock(input) {
            // Stock value updated, will be saved when Save is clicked
        }

        function saveAllVariants(productId, buttonElement) {
            // Find all variant inputs for this product
            const variantInputs = document.querySelectorAll(`input[data-product-id="${productId}"]`);
            
            if (variantInputs.length === 0) {
                alert('No variants found for this product');
                return;
            }
            
            // Prompt for cost per unit (applies to all variants)
            const costInput = prompt('Enter cost per unit for all stock changes (R):');
            if (costInput === null) {
                // User cancelled
                return;
            }
            const costNum = parseFloat(costInput);
            if (isNaN(costNum) || costNum < 0) {
                alert('Please enter a valid cost per unit (number >= 0)');
                return;
            }
            
            // Collect all variant updates
            const updates = [];
            let hasChanges = false;
            let hasInvalidInput = false;
            
            variantInputs.forEach(input => {
                const variantId = input.dataset.variant;
                const newStock = parseInt(input.value);
                
                if (isNaN(newStock) || newStock < 0) {
                    hasInvalidInput = true;
                    return;
                }
                
                // Find current stock from inventory data
                const currentItem = allInventoryData.find(item => 
                    String(item.productId) === String(productId) && 
                    String(item.variantId || '') === String(variantId)
                );
                
                const oldStock = currentItem ? (currentItem.stock || 0) : 0;
                
                if (newStock !== oldStock) {
                    hasChanges = true;
                    updates.push({
                        productId: productId,
                        variantId: variantId,
                        stock: newStock,
                        costPerUnit: costNum
                    });
                }
            });
            
            if (hasInvalidInput) {
                alert('Invalid stock value detected. Please check all inputs and ensure they are valid numbers >= 0.');
                return;
            }
            
            if (!hasChanges) {
                alert('No changes detected. All stock values are the same as before.');
                return;
            }
            
            // Disable button and show loading
            const button = buttonElement || event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Saving...';
            
            // Save all variants sequentially
            let savedCount = 0;
            let errors = [];
            
            const saveNext = () => {
                if (savedCount >= updates.length) {
                    // All done
                    if (errors.length > 0) {
                        alert(`Saved ${savedCount - errors.length} variants. ${errors.length} failed: ${errors.join(', ')}`);
                        button.textContent = originalText;
                        button.disabled = false;
                        loadInventory();
                    } else {
                        button.textContent = 'Saved!';
                        button.classList.add('bg-green-600');
                        button.classList.remove('bg-black');
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.classList.remove('bg-green-600');
                            button.classList.add('bg-black');
                            button.disabled = false;
                            loadInventory();
                        }, 2000);
                    }
                    return;
                }
                
                const update = updates[savedCount];
                adminFetch(`${BACKEND_URL}/api/admin/inventory/update`, {
                    method: 'POST',
                    body: JSON.stringify(update)
                })
                .then(data => {
                    if (data.success) {
                        savedCount++;
                        saveNext();
                    } else {
                        errors.push(update.variantId || 'unknown');
                        savedCount++;
                        saveNext();
                    }
                })
                .catch(err => {
                    console.error('Error updating stock:', err);
                    errors.push(update.variantId || 'unknown');
                    savedCount++;
                    saveNext();
                });
            };
            
            saveNext();
        }
        
        // Keep old function for backward compatibility (not used anymore)
        function saveStock(itemId, productId, variantId, buttonElement) {
            // This function is deprecated - use saveAllVariants instead
            alert('Please use the "Save All Changes" button at the bottom of the variants list.');
        }

        function refreshInventory() {
            loadInventory();
        }

        // Inbox functions
        function loadInbox() {
            const list = document.getElementById('inbox-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading emails...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/inbox`)
                .then(data => {
                    console.log('Inbox data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    // Sort by date (newest first) to ensure latest emails are shown
                    const sortedData = data.sort((a, b) => {
                        const dateA = new Date(a.date || 0);
                        const dateB = new Date(b.date || 0);
                        return dateB - dateA;
                    });
                    if (sortedData.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No emails</div>';
                        return;
                    }
                    list.innerHTML = sortedData.map(email => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition cursor-pointer ${email.read ? '' : 'bg-blue-50 border-blue-200'} ${email.sent ? 'bg-green-50 border-green-200' : ''}" onclick="viewEmail('${email.id}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold ${email.read ? 'text-gray-700' : 'text-black'}">${email.subject || '(No Subject)'}</p>
                                    <p class="text-sm text-gray-600 mt-1">${email.sent ? 'To:' : 'From:'} ${email.name || email.from || email.to || 'Unknown'}</p>
                                    <p class="text-xs text-gray-500 mt-1">${email.date ? new Date(email.date).toLocaleString() : 'Unknown date'}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${email.sent ? '<span class="px-2 py-1 bg-green-500 text-white rounded-full text-xs">Sent</span>' : ''}
                                    ${!email.read ? '<span class="px-2 py-1 bg-blue-500 text-white rounded-full text-xs">New</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Inbox loading error:', err);
                    list.innerHTML = `<div class="error-message">Error loading emails: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        // currentViewingEmail is declared at the top of the script
        
        function viewEmail(emailId) {
            adminFetch(`${BACKEND_URL}/api/admin/inbox`)
                .then(data => {
                    const email = data.find(e => e.id === emailId);
                    if (!email) {
                        alert('Email not found');
                        return;
                    }
                    
                    currentViewingEmail = email;
                    document.getElementById('view-email-subject').textContent = email.subject || '(No Subject)';
                    document.getElementById('view-email-from').textContent = email.name || email.from || email.to || 'Unknown';
                    document.getElementById('view-email-date').textContent = email.date ? new Date(email.date).toLocaleString() : 'Unknown';
                    
                    // Render email content with HTML support
                    const emailBody = document.getElementById('view-email-body');
                    const emailContent = email.html || email.body || email.message || '(No content)';
                    
                    // Use iframe for safe HTML rendering
                    emailBody.innerHTML = '';
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.minHeight = '400px';
                    iframe.style.border = '1px solid #e5e7eb';
                    iframe.style.borderRadius = '8px';
                    iframe.srcdoc = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { 
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                                    padding: 20px;
                                    margin: 0;
                                    line-height: 1.6;
                                    color: #333;
                                }
                                img { max-width: 100%; height: auto; }
                                a { color: #000; text-decoration: underline; }
                                table { width: 100%; border-collapse: collapse; }
                            </style>
                        </head>
                        <body>${emailContent}</body>
                        </html>
                    `;
                    emailBody.appendChild(iframe);
                    
                    document.getElementById('view-email-modal').classList.remove('hidden');
                    
                    // Mark as read
                    if (!email.read) {
                        markEmailAsRead(emailId);
                    }
                })
                .catch(err => {
                    console.error('Error loading email:', err);
                    alert('Error loading email: ' + err.message);
                });
        }
        
        function deleteEmail() {
            if (!currentViewingEmail) return;
            if (!confirm('Delete this email?')) return;
            
            adminFetch(`${BACKEND_URL}/api/admin/inbox/delete`, {
                method: 'POST',
                body: JSON.stringify({ emailId: currentViewingEmail.id })
            })
            .then(data => {
                if (data.success) {
                    closeViewEmail();
                    loadInbox();
                    updateBadges();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete email'));
                }
            })
            .catch(err => {
                console.error('Error deleting email:', err);
                alert('Error deleting email: ' + err.message);
            });
        }
        
        function closeViewEmail() {
            document.getElementById('view-email-modal').classList.add('hidden');
            currentViewingEmail = null;
        }
        
        function replyToEmail() {
            if (!currentViewingEmail) {
                alert('No email selected');
                return;
            }
            
            const replyFrom = currentViewingEmail.from || currentViewingEmail.name || '';
            const replySubject = currentViewingEmail.subject || '';
            
            closeViewEmail();
            
            // Small delay to ensure modal is closed
            setTimeout(() => {
                showComposeEmail(replyFrom, replySubject);
            }, 100);
        }
        
        function markEmailAsRead(emailId) {
            adminFetch(`${BACKEND_URL}/api/admin/inbox/read`, {
                method: 'POST',
                body: JSON.stringify({ emailId })
            })
            .then(data => {
                if (data.success) {
                    loadInbox();
                    updateBadges();
                }
            })
            .catch(err => {
                console.error('Error marking email as read:', err);
            });
        }
        
        function fetchEmails() {
            const list = document.getElementById('inbox-list');
            const originalHtml = list.innerHTML;
            const btn = document.getElementById('fetch-emails-btn') || document.querySelector('button[onclick="fetchEmails()"]');
            if (btn) {
                btn.disabled = true;
                const originalText = btn.textContent;
                btn.textContent = 'Fetching...';
            }
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Fetching emails from server...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/inbox/fetch`, {
                method: 'POST'
            })
            .then(data => {
                if (data.success) {
                    alert(`Fetched ${data.fetched || 0} emails from server. ${data.new || 0} new emails added. Total: ${data.total || 0} emails in inbox.`);
                    loadInbox(); // Reload to show all emails
                    updateBadges();
                } else {
                    throw new Error(data.error || 'Failed to fetch emails');
                }
            })
            .catch(err => {
                console.error('Error fetching emails:', err);
                list.innerHTML = originalHtml;
                alert('Error fetching emails: ' + err.message);
            })
            .finally(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Fetch Emails';
                }
            });
        }
        
        // Make showComposeEmail globally accessible
        function showComposeEmail(replyTo = null, replySubject = null) {
            console.log('showComposeEmail called with:', { replyTo, replySubject });
            
            try {
            const modal = document.getElementById('compose-email-modal');
            const form = document.getElementById('compose-email-form');
            const builder = document.getElementById('email-builder');
                
                // Check if required elements exist
                if (!modal) {
                    console.error('Compose email modal not found');
                    alert('Error: Email composer modal not found. Please refresh the page.');
                    return;
                }
                
                if (!form) {
                    console.error('Compose email form not found');
                    alert('Error: Email composer form not found. Please refresh the page.');
                    return;
                }
                
                if (!builder) {
                    console.error('Email builder not found');
                    alert('Error: Email builder not found. Please refresh the page.');
                    return;
                }
            
            // Clear saved sections when opening new compose
            emailBuilderSections = null;
            
            // Reset builder with proper styling
            builder.innerHTML = `
                <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-500 font-medium">Text Section</span>
                        <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                    </div>
                    <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content..."></textarea>
                </div>
            `;
            
            // Reset form
            if (replyTo) {
                const toField = document.getElementById('compose-to');
                const subjectField = document.getElementById('compose-subject');
                if (toField) toField.value = replyTo;
                if (subjectField) {
                    subjectField.value = replySubject ? (replySubject.startsWith('Re:') ? replySubject : `Re: ${replySubject}`) : 'Re: ';
                }
            } else {
                form.reset();
            }
            
            // Reset template section visibility based on context
            const context = window.currentEmailContext || {};
            const templateSection = document.getElementById('email-template-section');
            const addSubscribersBtn = document.getElementById('add-subscribers-btn');
            const templateSelect = document.getElementById('email-template-select');
            
            if (context.type === 'broadcast' || context.type === 'fulfiller') {
                if (templateSection) templateSection.classList.remove('hidden');
                if (templateSelect) templateSelect.value = '';
            } else {
                if (templateSection) templateSection.classList.add('hidden');
            }
            
            if (context.type === 'broadcast') {
                if (addSubscribersBtn) addSubscribersBtn.classList.remove('hidden');
            } else {
                if (addSubscribersBtn) addSubscribersBtn.classList.add('hidden');
            }
            
            // Reset preview mode
            const previewMode = document.getElementById('preview-mode');
            if (previewMode) previewMode.checked = false;
            
                // Show modal
                modal.classList.remove('hidden');
                console.log('Compose email modal opened successfully');
                
                // Re-setup form listener when modal is opened
                setTimeout(setupComposeEmailForm, 100);
            } catch (error) {
                console.error('Error in showComposeEmail:', error);
                alert('Error opening email composer: ' + error.message);
            }
        }
        
        // Ensure function is accessible globally
        window.showComposeEmail = showComposeEmail;
        
        // Function to close compose email modal
        function closeComposeEmail() {
            try {
                const modal = document.getElementById('compose-email-modal');
                const form = document.getElementById('compose-email-form');
                const builder = document.getElementById('email-builder');
                
                if (modal) modal.classList.add('hidden');
                if (form) form.reset();
                if (builder) builder.innerHTML = '';
                
            // Clear context
            if (window.currentEmailContext) {
                window.currentEmailContext = null;
                }
            } catch (error) {
                console.error('Error closing compose email:', error);
            }
        }
        
        // Ensure function is accessible globally
        window.closeComposeEmail = closeComposeEmail;
        
        // Context-specific email composer functions
        function openFulfillerEmailComposer() {
            const fulfillerId = document.getElementById('fulfiller-select').value;
            const orderId = document.getElementById('fulfiller-order-select').value;
            
            if (!fulfillerId) {
                alert('Please select a fulfiller first');
                return;
            }
            
            // Get fulfiller email
            adminFetch(`${BACKEND_URL}/api/admin/fulfillers`)
                .then(data => {
                    const fulfiller = data.find(f => f.id === fulfillerId);
                    if (!fulfiller) {
                        alert('Fulfiller not found');
                        return;
                    }
                    
                    // Get order details if order is selected
                    let orderDetails = '';
                    let subject = `Order Notification - ${fulfiller.name}`;
                    
                    if (orderId) {
                        adminFetch(`${BACKEND_URL}/api/admin/orders`)
                            .then(orders => {
                                const order = orders.find(o => o.id === orderId);
                                if (order) {
                                    orderDetails = `Order ID: ${order.id}\nCustomer: ${order.customerName}\nEmail: ${order.customerEmail}\nPhone: ${order.customerPhone}\n\nItems:\n${order.items.map(i => `- ${i.name} (${i.variant || 'N/A'}) x${i.quantity} - R${i.price.toFixed(2)}`).join('\n')}\n\nTotal: R${order.total.toFixed(2)}\n\nShipping: ${order.shippingMethod}\nAddress: ${order.deliveryAddress || 'N/A'}`;
                                    subject = `Order #${order.id} - ${fulfiller.name}`;
                                }
                                
                                window.currentEmailContext = { type: 'fulfiller', fulfillerId, orderId, orderDetails };
                                showComposeEmail(fulfiller.email, subject);
                                
                                // Show template section and set fulfiller template
                                    setTimeout(() => {
                                    const templateSection = document.getElementById('email-template-section');
                                    const templateSelect = document.getElementById('email-template-select');
                                    if (templateSection) templateSection.classList.remove('hidden');
                                    if (templateSelect) {
                                        templateSelect.value = 'fulfiller-order';
                                        loadEmailTemplate();
                                        }
                                    }, 100);
                            })
                            .catch(err => {
                                window.currentEmailContext = { type: 'fulfiller', fulfillerId, orderId };
                                showComposeEmail(fulfiller.email, subject);
                                setTimeout(() => {
                                    const templateSection = document.getElementById('email-template-section');
                                    const templateSelect = document.getElementById('email-template-select');
                                    if (templateSection) templateSection.classList.remove('hidden');
                                    if (templateSelect) {
                                        templateSelect.value = 'fulfiller-order';
                                        loadEmailTemplate();
                                    }
                                }, 100);
                            });
                    } else {
                        window.currentEmailContext = { type: 'fulfiller', fulfillerId };
                        showComposeEmail(fulfiller.email, subject);
                        setTimeout(() => {
                            const templateSection = document.getElementById('email-template-section');
                            const templateSelect = document.getElementById('email-template-select');
                            if (templateSection) templateSection.classList.remove('hidden');
                            if (templateSelect) {
                                templateSelect.value = 'fulfiller-order';
                                loadEmailTemplate();
                            }
                        }, 100);
                    }
                })
                .catch(err => {
                    alert('Error loading fulfiller: ' + err.message);
                });
        }
        
        function openBroadcastEmailComposer() {
            // Load subscribers and products for selection
            adminFetch(`${BACKEND_URL}/api/admin/subscribers`)
                .then(subscribers => {
                    adminFetch(`${BACKEND_URL}/api/admin/inventory`)
                        .then(products => {
                            window.currentEmailContext = { 
                                type: 'broadcast',
                                subscribers: subscribers || [],
                                products: products || []
                            };
                            
                            // Add all subscriber emails to "to" field
                            const subscriberEmails = (subscribers || []).map(s => s.email).join(', ');
                            showComposeEmail(subscriberEmails, 'Newsletter Update');
                            
                            // Show template section and add subscribers button
                            setTimeout(() => {
                                const templateSection = document.getElementById('email-template-section');
                                const addSubscribersBtn = document.getElementById('add-subscribers-btn');
                                if (templateSection) templateSection.classList.remove('hidden');
                                if (addSubscribersBtn) addSubscribersBtn.classList.remove('hidden');
                                
                                // Removed featured products section as requested
                            }, 100);
                        })
                        .catch(err => {
                            console.error('Error loading products:', err);
                            window.currentEmailContext = { type: 'broadcast', subscribers: subscribers || [] };
                            const subscriberEmails = (subscribers || []).map(s => s.email).join(', ');
                            showComposeEmail(subscriberEmails, 'Newsletter Update');
                            setTimeout(() => {
                                const templateSection = document.getElementById('email-template-section');
                                const addSubscribersBtn = document.getElementById('add-subscribers-btn');
                                if (templateSection) templateSection.classList.remove('hidden');
                                if (addSubscribersBtn) addSubscribersBtn.classList.remove('hidden');
                            }, 100);
                        });
                })
                .catch(err => {
                    console.error('Error loading subscribers:', err);
                    window.currentEmailContext = { type: 'broadcast' };
                    showComposeEmail('', 'Newsletter Update');
                    setTimeout(() => {
                        const templateSection = document.getElementById('email-template-section');
                        if (templateSection) templateSection.classList.remove('hidden');
                    }, 100);
                });
        }
        
        function addAllSubscribers() {
            const context = window.currentEmailContext || {};
            const subscribers = context.subscribers || [];
            if (subscribers.length === 0) {
                // Try to fetch subscribers
                adminFetch(`${BACKEND_URL}/api/admin/subscribers`)
                    .then(data => {
                        const emails = (data || []).map(s => s.email).join(', ');
                        document.getElementById('compose-to').value = emails;
                    })
                    .catch(err => {
                        alert('Error loading subscribers: ' + err.message);
                    });
            } else {
                const emails = subscribers.map(s => s.email).join(', ');
                document.getElementById('compose-to').value = emails;
            }
        }
        
        function loadEmailTemplate() {
            const templateSelect = document.getElementById('email-template-select');
            const template = templateSelect.value;
            const context = window.currentEmailContext || {};
            
            if (!template) return;
            
            const builder = document.getElementById('email-builder');
            let templateHtml = '';
            let subject = document.getElementById('compose-subject').value || '';
            
            switch(template) {
                case 'promotion':
                    subject = subject || 'üéâ Special Promotion - Limited Time Offer!';
                    templateHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="image">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Image Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="url" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Image URL..." value="https://dl.dropboxusercontent.com/scl/fi/j0pgw2egryb9f0470f3p3/1-2.png?rlkey=xaw4k5w0yhwswfae3pi1n0g2r&st=vnlwftci&dl=1">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="heading">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Heading Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <select class="w-full mb-2 px-2 py-1 border border-gray-200 rounded text-sm">
                                <option value="h1">H1 (Large)</option>
                                <option value="h2" selected>H2 (Medium)</option>
                                <option value="h3">H3 (Small)</option>
                            </select>
                            <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm font-bold" placeholder="Enter heading text..." value="üéâ Special Promotion - Limited Time Offer!">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content...">Don't miss out on our amazing promotion! Shop now and save big on selected items.</textarea>
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="button">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Button Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="text" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button text..." value="Shop Now">
                            <input type="url" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button URL..." value="https://saintventura.co.za">
                        </div>
                    `;
                    break;
                case 'new-product':
                    subject = subject || '‚ú® New Product Launch - Check It Out!';
                    templateHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="image">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Image Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="url" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Image URL..." value="https://dl.dropboxusercontent.com/scl/fi/6ribhwbytdqfqva6jgf3s/1-16.png?rlkey=s61uev3dxmsmo4coifrqtozge&st=z3y4nuri&dl=1">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="heading">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Heading Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <select class="w-full mb-2 px-2 py-1 border border-gray-200 rounded text-sm">
                                <option value="h1" selected>H1 (Large)</option>
                                <option value="h2">H2 (Medium)</option>
                                <option value="h3">H3 (Small)</option>
                            </select>
                            <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm font-bold" placeholder="Enter heading text..." value="‚ú® New Product Launch!">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content...">We're excited to introduce our latest collection! Discover new styles and be the first to get your hands on these exclusive pieces.</textarea>
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="button">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Button Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="text" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button text..." value="View New Products">
                            <input type="url" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button URL..." value="https://saintventura.co.za">
                        </div>
                    `;
                    break;
                case 'news':
                    subject = subject || 'üì∞ Saint Ventura News & Updates';
                    templateHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="image">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Image Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="url" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Image URL..." value="https://dl.dropboxusercontent.com/scl/fi/qs6id9xzrvfp8dctj2lqf/1-15.png?rlkey=shaa8t54va6ap95kulvvk1jee&st=tpwythhm&dl=1">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="heading">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Heading Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <select class="w-full mb-2 px-2 py-1 border border-gray-200 rounded text-sm">
                                <option value="h1">H1 (Large)</option>
                                <option value="h2" selected>H2 (Medium)</option>
                                <option value="h3">H3 (Small)</option>
                            </select>
                            <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm font-bold" placeholder="Enter heading text..." value="üì∞ Latest News & Updates">
                        </div>
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="6" placeholder="Enter text content...">Stay updated with the latest news from Saint Ventura. We have exciting updates to share with you!</textarea>
                        </div>
                    `;
                    break;
                case 'fulfiller-order':
                    if (context.type === 'fulfiller' && context.orderDetails) {
                        templateHtml = `
                            <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                    <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                                </div>
                                <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="8" placeholder="Enter text content...">Hi there,

You have a new order to fulfill:

${context.orderDetails}

Please process this order as soon as possible.

Thank you!</textarea>
                            </div>
                        `;
                    } else {
                        templateHtml = `
                            <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                    <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                                </div>
                                <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="8" placeholder="Enter order details...">Hi there,

You have a new order to fulfill. Please check the order details and process it as soon as possible.

Thank you!</textarea>
                            </div>
                        `;
                    }
                    break;
            }
            
            if (templateHtml) {
                builder.innerHTML = templateHtml;
                if (subject) {
                    document.getElementById('compose-subject').value = subject;
                }
            }
        }
        
        function openAbandonedCartEmailComposer() {
            // Load abandoned carts for selection
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts`)
                .then(carts => {
                    window.currentEmailContext = { 
                        type: 'abandoned-cart',
                        carts: carts || []
                    };
                    showComposeEmail('', 'Complete Your Purchase');
                    
                    // Add cart selection UI after modal opens
                    setTimeout(() => {
                        const builder = document.getElementById('email-builder');
                        const cartSelectHtml = `
                            <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="cart-select">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500 font-medium">Select Abandoned Carts (Leave empty to send to all)</span>
                                </div>
                                <select id="abandoned-cart-select" multiple class="w-full px-3 py-2 border border-gray-200 rounded text-sm" size="5">
                                    ${(carts || []).map(c => `<option value="${c.id}">${c.customerEmail || c.email || 'Unknown'} - R${(c.total || 0).toFixed(2)}</option>`).join('')}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select specific carts, or leave empty to send to all</p>
                            </div>
                        `;
                        builder.insertAdjacentHTML('afterbegin', cartSelectHtml);
                    }, 100);
                })
                .catch(err => {
                    console.error('Error loading abandoned carts:', err);
                    window.currentEmailContext = { type: 'abandoned-cart' };
                    showComposeEmail('', 'Complete Your Purchase');
                });
        }
        
        function addEmailSection(type) {
            const builder = document.getElementById('email-builder');
            let sectionHtml = '';
            
            switch(type) {
                case 'text':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Text Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content..."></textarea>
                        </div>
                    `;
                    break;
                case 'heading':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="heading">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Heading Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <select class="w-full mb-2 px-2 py-1 border border-gray-200 rounded text-sm">
                                <option value="h1">H1 (Large)</option>
                                <option value="h2">H2 (Medium)</option>
                                <option value="h3">H3 (Small)</option>
                            </select>
                            <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm font-bold" placeholder="Enter heading text...">
                        </div>
                    `;
                    break;
                case 'image':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="image">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Image Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="url" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Image URL...">
                            <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Alt text (optional)">
                        </div>
                    `;
                    break;
                case 'button':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="button">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Button Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="text" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button text...">
                            <input type="url" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button URL...">
                        </div>
                    `;
                    break;
                case 'divider':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="divider">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Divider Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <div class="border-t-2 border-gray-300"></div>
                        </div>
                    `;
                    break;
                case 'spacer':
                    sectionHtml = `
                        <div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="spacer">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-500 font-medium">Spacer Section</span>
                                <button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button>
                            </div>
                            <input type="number" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Height in pixels (e.g., 20)" value="20" min="10" max="100">
                        </div>
                    `;
                    break;
            }
            
            builder.insertAdjacentHTML('beforeend', sectionHtml);
        }
        
        function removeEmailSection(button) {
            button.closest('.email-section').remove();
        }
        
        // emailBuilderSections is declared at the top of the script
        
        function toggleEmailPreview() {
            const previewMode = document.getElementById('preview-mode').checked;
            const builder = document.getElementById('email-builder');
            
            if (previewMode) {
                // Save current sections before showing preview
                const sections = builder.querySelectorAll('.email-section');
                emailBuilderSections = Array.from(sections).map(section => {
                    const type = section.dataset.type;
                    const sectionData = { type: type };
                    
                    // Save input values
                    if (type === 'text') {
                        sectionData.value = section.querySelector('textarea')?.value || '';
                    } else if (type === 'heading') {
                        sectionData.selectValue = section.querySelector('select')?.value || 'h2';
                        sectionData.inputValue = section.querySelector('input')?.value || '';
                    } else if (type === 'image' || type === 'button') {
                        sectionData.inputs = Array.from(section.querySelectorAll('input')).map(inp => inp.value || '');
                    } else if (type === 'spacer') {
                        sectionData.value = section.querySelector('input')?.value || 20;
                    }
                    return sectionData;
                });
                
                // Generate HTML preview
                let html = '';
                
                sections.forEach(section => {
                    const type = section.dataset.type;
                    switch(type) {
                        case 'text':
                            const text = section.querySelector('textarea').value;
                            html += `<p style="margin: 10px 0; line-height: 1.6;">${text.replace(/\n/g, '<br>')}</p>`;
                            break;
                        case 'heading':
                            const headingLevel = section.querySelector('select').value;
                            const headingText = section.querySelector('input').value;
                            html += `<${headingLevel} style="margin: 15px 0; font-weight: bold;">${headingText}</${headingLevel}>`;
                            break;
                        case 'image':
                            const imgUrl = section.querySelectorAll('input')[0].value;
                            const altText = section.querySelectorAll('input')[1].value;
                            if (imgUrl) {
                                html += `<img src="${imgUrl}" alt="${altText || ''}" style="max-width: 100%; height: auto; margin: 10px 0; display: block;">`;
                            }
                            break;
                        case 'button':
                            const btnText = section.querySelectorAll('input')[0].value;
                            const btnUrl = section.querySelectorAll('input')[1].value;
                            if (btnText && btnUrl) {
                                html += `<div style="margin: 15px 0; text-align: center;"><a href="${btnUrl}" style="display: inline-block; padding: 12px 24px; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold;">${btnText}</a></div>`;
                            }
                            break;
                        case 'divider':
                            html += `<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">`;
                            break;
                        case 'spacer':
                            const height = section.querySelector('input').value || 20;
                            html += `<div style="height: ${height}px;"></div>`;
                            break;
                    }
                });
                
                builder.innerHTML = `
                    <div class="border-2 border-blue-300 rounded p-4 bg-gray-50">
                        <div class="mb-2 text-xs text-blue-600 font-medium">Preview Mode</div>
                        <div class="bg-white p-4 rounded border" style="font-family: Arial, sans-serif;">
                            ${html || '<p class="text-gray-400">No content to preview</p>'}
                        </div>
                    </div>
                `;
            } else {
                // Restore builder with saved sections
                if (emailBuilderSections && emailBuilderSections.length > 0) {
                    builder.innerHTML = '';
                    emailBuilderSections.forEach(sectionData => {
                        // Recreate section HTML with saved values
                        let sectionHtml = '';
                        switch(sectionData.type) {
                            case 'text':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Text Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content...">${(sectionData.value || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea></div>`;
                                break;
                            case 'heading':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="heading"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Heading Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><select class="w-full mb-2 px-2 py-1 border border-gray-200 rounded text-sm"><option value="h1" ${sectionData.selectValue === 'h1' ? 'selected' : ''}>H1 (Large)</option><option value="h2" ${sectionData.selectValue === 'h2' ? 'selected' : ''}>H2 (Medium)</option><option value="h3" ${sectionData.selectValue === 'h3' ? 'selected' : ''}>H3 (Small)</option></select><input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm font-bold" placeholder="Enter heading text..." value="${(sectionData.inputValue || '').replace(/"/g, '&quot;')}"></div>`;
                                break;
                            case 'image':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="image"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Image Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><input type="url" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Image URL..." value="${(sectionData.inputs?.[0] || '').replace(/"/g, '&quot;')}"><input type="text" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Alt text (optional)" value="${(sectionData.inputs?.[1] || '').replace(/"/g, '&quot;')}"></div>`;
                                break;
                            case 'button':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="button"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Button Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><input type="text" class="w-full mb-2 px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button text..." value="${(sectionData.inputs?.[0] || '').replace(/"/g, '&quot;')}"><input type="url" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Button URL..." value="${(sectionData.inputs?.[1] || '').replace(/"/g, '&quot;')}"></div>`;
                                break;
                            case 'divider':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="divider"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Divider Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><div class="border-t-2 border-gray-300"></div></div>`;
                                break;
                            case 'spacer':
                                sectionHtml = `<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="spacer"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Spacer Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><input type="number" class="w-full px-3 py-2 border border-gray-200 rounded text-sm" placeholder="Height in pixels (e.g., 20)" value="${sectionData.value || 20}" min="10" max="100"></div>`;
                                break;
                        }
                        if (sectionHtml) {
                            builder.insertAdjacentHTML('beforeend', sectionHtml);
                        }
                    });
                    emailBuilderSections = null;
                } else {
                    // If no saved sections, restore default
                    builder.innerHTML = '<div class="email-section border border-gray-200 rounded p-3 bg-white" data-type="text"><div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-500 font-medium">Text Section</span><button type="button" onclick="removeEmailSection(this)" class="text-red-500 text-xs hover:text-red-700">Remove</button></div><textarea class="w-full px-3 py-2 border border-gray-200 rounded text-sm" rows="4" placeholder="Enter text content..."></textarea></div>';
                }
            }
        }
        
        // Compose email form handler - set up when form is available
        function setupComposeEmailForm() {
            const composeForm = document.getElementById('compose-email-form');
            if (!composeForm) {
                console.warn('Compose email form not found');
                return;
            }
            
            // Remove existing listener to avoid duplicates
            const newForm = composeForm.cloneNode(true);
            composeForm.parentNode.replaceChild(newForm, composeForm);
            
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Compose email form submitted');
                
                let submitBtn = null;
                let originalText = '';
                
                try {
                    const toField = document.getElementById('compose-to');
                    const subjectField = document.getElementById('compose-subject');
                    
                    if (!toField || !subjectField) {
                        console.error('Compose form fields not found');
                        alert('Error: Email form fields not found. Please refresh the page.');
                        return;
                    }
                    
                    const to = toField.value.trim();
                    const subject = subjectField.value.trim();
                    
                    console.log('Email form values:', { to, subject });
                    
                    // Validate required fields
                    if (!to) {
                        alert('Please enter a recipient email address');
                        return;
                    }
                    
                    if (!subject) {
                        alert('Please enter an email subject');
                        return;
                    }
                    
                    // Build HTML from sections
                    const builder = document.getElementById('email-builder');
                    if (!builder) {
                        console.error('Email builder not found');
                        alert('Error: Email builder not found. Please refresh the page.');
                        return;
                    }
                    
                    const sections = builder.querySelectorAll('.email-section');
                    let html = '';
                    let text = '';
                    
                    sections.forEach(section => {
                        const type = section.dataset.type;
                        switch(type) {
                            case 'text':
                                const textArea = section.querySelector('textarea');
                                if (textArea) {
                                    const textContent = textArea.value;
                                    html += `<p style="margin: 10px 0; line-height: 1.6; font-family: Arial, sans-serif;">${textContent.replace(/\n/g, '<br>')}</p>`;
                                    text += textContent + '\n\n';
                                }
                                break;
                            case 'heading':
                                const headingSelect = section.querySelector('select');
                                const headingInput = section.querySelector('input');
                                if (headingSelect && headingInput) {
                                    const headingLevel = headingSelect.value;
                                    const headingText = headingInput.value;
                                    html += `<${headingLevel} style="margin: 15px 0; font-weight: bold; font-family: Arial, sans-serif;">${headingText}</${headingLevel}>`;
                                    text += headingText + '\n\n';
                                }
                                break;
                            case 'image':
                                const imgInputs = section.querySelectorAll('input');
                                if (imgInputs.length >= 1) {
                                    const imgUrl = imgInputs[0].value;
                                    const altText = imgInputs[1]?.value || '';
                                    if (imgUrl) {
                                        html += `<img src="${imgUrl}" alt="${altText || ''}" style="max-width: 100%; height: auto; margin: 10px 0; display: block;">`;
                                        text += `[Image: ${altText || imgUrl}]\n\n`;
                                    }
                                }
                                break;
                            case 'button':
                                const btnInputs = section.querySelectorAll('input');
                                if (btnInputs.length >= 2) {
                                    const btnText = btnInputs[0].value;
                                    const btnUrl = btnInputs[1].value;
                                    if (btnText && btnUrl) {
                                        html += `<div style="margin: 15px 0; text-align: center;"><a href="${btnUrl}" style="display: inline-block; padding: 12px 24px; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; font-weight: bold; font-family: Arial, sans-serif;">${btnText}</a></div>`;
                                        text += `${btnText}: ${btnUrl}\n\n`;
                                    }
                                }
                                break;
                            case 'divider':
                                html += `<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;">`;
                                text += '---\n\n';
                                break;
                            case 'spacer':
                                const spacerInput = section.querySelector('input');
                                if (spacerInput) {
                                    const height = spacerInput.value || 20;
                                    html += `<div style="height: ${height}px;"></div>`;
                                }
                                break;
                        }
                    });
                    
                    const body = html || text || '';
                    
                    if (!body.trim()) {
                        alert('Please add some content to your email');
                        return;
                    }
                    
                    submitBtn = newForm.querySelector('button[type="submit"]');
                    if (!submitBtn) {
                        console.error('Submit button not found');
                        alert('Error: Submit button not found');
                        return;
                    }
                    
                    originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Sending...';
                    
                    console.log('Sending email with context:', window.currentEmailContext);
                    
                    // Handle different contexts
                    const context = window.currentEmailContext || { type: 'inbox' };
                    
                    if (context.type === 'fulfiller') {
                        // Send to fulfiller
                        adminFetch(`${BACKEND_URL}/api/admin/fulfillers/notify`, {
                            method: 'POST',
                            body: JSON.stringify({ 
                                fulfillerId: context.fulfillerId, 
                                orderDetails: body,
                                subject: subject,
                                html: html
                            })
                        })
                        .then(data => {
                            if (data && data.success) {
                                alert('Email sent to fulfiller successfully!');
                                closeComposeEmail();
                                loadFulfillers();
                            } else {
                                alert('Error: ' + (data?.error || 'Failed to send email'));
                            }
                        })
                        .catch(err => {
                            console.error('Error sending email:', err);
                            alert('Error sending email: ' + (err.message || 'Unknown error'));
                        })
                        .finally(() => {
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                    } else if (context.type === 'broadcast') {
                        // Send to all subscribers (use "to" field which already has all subscribers)
                        const productSelect = document.getElementById('broadcast-products');
                        const products = productSelect ? Array.from(productSelect.selectedOptions || []).map(o => o.value) : [];
                        const templateSelect = document.getElementById('email-template-select');
                        const template = templateSelect ? templateSelect.value : '';
                        adminFetch(`${BACKEND_URL}/api/admin/broadcast`, {
                            method: 'POST',
                            body: JSON.stringify({ 
                                subject: subject, 
                                message: body,
                                html: html,
                                products: products,
                                template: template,
                                recipients: to // Include recipients in case user modified them
                            })
                        })
                        .then(data => {
                            if (data && data.success) {
                                alert(`Email sent to ${data.sent || 0} subscribers${data.total ? ` out of ${data.total}` : ''}`);
                                closeComposeEmail();
                                loadBroadcast();
                            } else {
                                alert('Error: ' + (data?.error || 'Failed to send broadcast'));
                            }
                        })
                        .catch(err => {
                            console.error('Error sending broadcast:', err);
                            alert('Error sending broadcast: ' + (err.message || 'Unknown error'));
                        })
                        .finally(() => {
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                    } else if (context.type === 'abandoned-cart') {
                        // Send to selected or all abandoned carts
                        const cartSelect = document.getElementById('abandoned-cart-select');
                        const selectedCarts = cartSelect ? Array.from(cartSelect.selectedOptions || []).map(o => o.value) : [];
                        adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts/remind-all`, {
                            method: 'POST',
                            body: JSON.stringify({ 
                                subject: subject, 
                                message: body,
                                html: html,
                                cartIds: selectedCarts.length > 0 ? selectedCarts : null // null means all
                            })
                        })
                        .then(data => {
                            if (data && data.success) {
                                alert(`Reminder emails sent to ${data.sent || 0} customers`);
                                closeComposeEmail();
                                loadAbandonedCarts();
                            } else {
                                alert('Error: ' + (data?.error || 'Failed to send reminders'));
                            }
                        })
                        .catch(err => {
                            console.error('Error sending reminders:', err);
                            alert('Error sending reminders: ' + (err.message || 'Unknown error'));
                        })
                        .finally(() => {
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                    } else {
                        // Default: send to inbox (supports multiple recipients)
                        // Parse multiple recipients (comma-separated)
                        const recipients = to.split(',').map(r => r.trim()).filter(r => r);
                        console.log('Sending to recipients:', recipients);
                        adminFetch(`${BACKEND_URL}/api/admin/inbox/send`, {
                            method: 'POST',
                            body: JSON.stringify({ to: recipients.join(', '), subject, body, html: html })
                        })
                        .then(data => {
                            console.log('Email send response:', data);
                            if (data && data.success) {
                                alert('Email sent successfully!');
                                closeComposeEmail();
                                loadInbox();
                                updateBadges();
                            } else {
                                alert('Error: ' + (data?.error || 'Failed to send email'));
                            }
                        })
                        .catch(err => {
                            console.error('Error sending email:', err);
                            alert('Error sending email: ' + (err.message || 'Unknown error'));
                        })
                        .finally(() => {
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error in compose email form submission:', error);
                    alert('Error: ' + (error.message || 'Failed to process email'));
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
            });
            console.log('Compose email form event listener set up successfully');
        }
        
        // Set up form listener when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupComposeEmailForm);
        } else {
            setupComposeEmailForm();
        }
        
        // Re-setup form listener when modal is opened - wrap the original function after it's defined
        setTimeout(function() {
            const originalShowComposeEmail = window.showComposeEmail;
            if (originalShowComposeEmail) {
                window.showComposeEmail = function(replyTo = null, replySubject = null) {
                    originalShowComposeEmail(replyTo, replySubject);
                    // Re-setup form listener when modal is opened
                    setTimeout(setupComposeEmailForm, 100);
                };
            }
        }, 0);
        
        // Search inbox
        document.getElementById('inbox-search')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            adminFetch(`${BACKEND_URL}/api/admin/inbox`)
                .then(data => {
                    if (!Array.isArray(data)) return;
                    const filtered = data.filter(email => 
                        (email.subject || '').toLowerCase().includes(searchTerm) ||
                        (email.from || '').toLowerCase().includes(searchTerm) ||
                        (email.name || '').toLowerCase().includes(searchTerm) ||
                        (email.body || email.message || '').toLowerCase().includes(searchTerm)
                    );
                    const list = document.getElementById('inbox-list');
                    if (filtered.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No emails found</div>';
                        return;
                    }
                    list.innerHTML = filtered.map(email => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition cursor-pointer ${email.read ? '' : 'bg-blue-50 border-blue-200'} ${email.sent ? 'bg-green-50 border-green-200' : ''}" onclick="viewEmail('${email.id}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-semibold ${email.read ? 'text-gray-700' : 'text-black'}">${email.subject || '(No Subject)'}</p>
                                    <p class="text-sm text-gray-600 mt-1">${email.sent ? 'To:' : 'From:'} ${email.name || email.from || email.to || 'Unknown'}</p>
                                    <p class="text-xs text-gray-500 mt-1">${email.date ? new Date(email.date).toLocaleString() : 'Unknown date'}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${email.sent ? '<span class="px-2 py-1 bg-green-500 text-white rounded-full text-xs">Sent</span>' : ''}
                                    ${!email.read ? '<span class="px-2 py-1 bg-blue-500 text-white rounded-full text-xs">New</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                });
        });

        function refreshInbox() {
            // First fetch new emails from IMAP, then load inbox
            const list = document.getElementById('inbox-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Fetching latest emails...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/inbox/fetch`, {
                method: 'POST'
            })
            .then(data => {
                console.log('Email fetch result:', data);
                if (data.success) {
                    console.log(`Fetched ${data.fetched || 0} emails, ${data.new || 0} new emails added`);
                    if (data.new > 0) {
                        // Show notification
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                        notification.textContent = `Fetched ${data.new} new email(s)`;
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                    }
                }
                // Load inbox regardless of fetch result
            loadInbox();
            })
            .catch(err => {
                console.error('Error fetching emails:', err);
                // Still load inbox even if fetch fails
                loadInbox();
            });
        }

        // Broadcast functions
        function loadBroadcast() {
            // Load subscribers
            adminFetch(`${BACKEND_URL}/api/admin/subscribers`)
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid subscribers data format');
                    }
                    document.getElementById('subscriber-count').textContent = data.length;
                    const list = document.getElementById('subscribers-list');
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-4 text-gray-500">No subscribers</div>';
                        return;
                    }
                    list.innerHTML = data.map(sub => `
                        <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                            <span class="text-sm">${sub.email}</span>
                            <span class="text-xs text-gray-500">${new Date(sub.date).toLocaleDateString()}</span>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading subscribers:', err);
                    document.getElementById('subscribers-list').innerHTML = 
                        `<div class="error-message">Error loading subscribers: ${err.message || 'Unknown error'}</div>`;
                });
            
            // Set up add subscriber form
            const addSubscriberForm = document.getElementById('add-subscriber-form');
            if (addSubscriberForm) {
                addSubscriberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('new-subscriber-email');
                    const email = emailInput.value.trim();
                    
                    if (!email || !email.includes('@')) {
                        alert('Please enter a valid email address');
                        return;
                    }
                    
                    try {
                        // Use the newsletter subscription endpoint
                        const response = await fetch(`${BACKEND_URL}/api/newsletter-subscribe`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email })
                        });
                        
                        const data = await response.json();
                        if (data.success || response.ok) {
                            alert('Subscriber added successfully!');
                            emailInput.value = '';
                            loadBroadcast(); // Reload subscribers list
                        } else {
                            alert('Error: ' + (data.error || 'Failed to add subscriber'));
                        }
                    } catch (err) {
                        console.error('Error adding subscriber:', err);
                        alert('Error adding subscriber: ' + err.message);
                    }
                });
            }

            // Load products
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid products data format');
                    }
                    const select = document.getElementById('broadcast-products');
                    if (select) {
                        select.innerHTML = '<option value="">Select products...</option>' +
                            data.map(p => `<option value="${p.id}">${p.name} - R${(p.price || 0).toFixed(2)}</option>`).join('');
                    }
                })
                .catch(err => {
                    console.error('Error loading products:', err);
                    const select = document.getElementById('broadcast-products');
                    if (select) {
                        select.innerHTML = `<option value="">Error loading products</option>`;
                    }
                });
        }

        document.getElementById('broadcast-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            const template = document.getElementById('broadcast-template').value;
            const subject = document.getElementById('broadcast-subject').value;
            const message = document.getElementById('broadcast-message').value;
            const products = Array.from(document.getElementById('broadcast-products').selectedOptions).map(o => o.value);

            if (!subject || !message) {
                alert('Please fill in subject and message');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            adminFetch(`${BACKEND_URL}/api/admin/broadcast`, {
                method: 'POST',
                body: JSON.stringify({ template, subject, message, products })
            })
            .then(data => {
                console.log('Broadcast response:', data);
                if (data.success) {
                    alert(`Email sent to ${data.sent || 0} subscribers${data.total ? ` out of ${data.total}` : ''}`);
                    document.getElementById('broadcast-form').reset();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Broadcast error:', err);
                alert('Error sending broadcast: ' + err.message);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });

        // Abandoned carts functions
        function loadAbandonedCarts() {
            const list = document.getElementById('abandoned-carts-list');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading abandoned carts...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts`)
                .then(data => {
                    console.log('Abandoned carts data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No abandoned carts</div>';
                        return;
                    }
                    list.innerHTML = data.map(cart => {
                        // Calculate time abandoned
                        let timeAbandoned = 'Unknown';
                        if (cart.date) {
                            const abandonedDate = new Date(cart.date);
                            const now = new Date();
                            const diffMs = now - abandonedDate;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);
                            
                            if (diffMins < 1) {
                                timeAbandoned = 'Just now';
                            } else if (diffMins < 60) {
                                timeAbandoned = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                            } else if (diffHours < 24) {
                                timeAbandoned = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                            } else if (diffDays < 30) {
                                timeAbandoned = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                            } else {
                                const diffMonths = Math.floor(diffDays / 30);
                                timeAbandoned = `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
                            }
                        }
                        
                        return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <p class="font-semibold text-lg">${cart.email || 'Guest'}</p>
                                    <p class="text-sm text-gray-600 mt-1">${(cart.items || []).length} item${(cart.items || []).length !== 1 ? 's' : ''}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-medium text-gray-500 mb-1">Abandoned</p>
                                    <p class="text-sm font-semibold text-red-600">${timeAbandoned}</p>
                                    <p class="text-xs text-gray-400 mt-1">${cart.date ? new Date(cart.date).toLocaleString() : 'N/A'}</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">
                                <p class="text-lg font-bold">Total: R${(cart.total || 0).toFixed(2)}</p>
                                ${cart.email ? `<button onclick="sendCartReminder('${cart.id}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition">Send Reminder</button>` : '<span class="text-xs text-gray-400">No email</span>'}
                            </div>
                        </div>
                    `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Error loading abandoned carts:', err);
                    list.innerHTML = `<div class="error-message">Error loading abandoned carts: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function sendCartReminder(cartId) {
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts/remind`, {
                method: 'POST',
                body: JSON.stringify({ cartId })
            })
            .then(data => {
                if (data.success) {
                    alert('Reminder email sent');
                    loadAbandonedCarts();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send reminder'));
                }
            })
            .catch(err => {
                console.error('Error sending reminder:', err);
                alert('Error: ' + err.message);
            });
        }

        function sendAbandonedCartEmails() {
            if (!confirm('Send reminder emails to all customers with abandoned carts?')) return;
            adminFetch(`${BACKEND_URL}/api/admin/abandoned-carts/remind-all`, {
                method: 'POST'
            })
            .then(data => {
                if (data.success) {
                    alert(`Reminder emails sent to ${data.sent || 0} customers`);
                    loadAbandonedCarts();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send reminders'));
                }
            })
            .catch(err => {
                console.error('Error sending reminders:', err);
                alert('Error: ' + err.message);
            });
        }

        function refreshAbandonedCarts() {
            loadAbandonedCarts();
        }

        // Fulfillers functions
        function loadFulfillers() {
            const list = document.getElementById('fulfillers-list');
            const select = document.getElementById('fulfiller-select');
            list.innerHTML = '<div class="text-center py-4 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading fulfillers...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/fulfillers`)
                .then(data => {
                    console.log('Fulfillers data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-4 text-gray-500">No fulfillers added</div>';
                        select.innerHTML = '<option value="">No fulfillers available</option>';
                    } else {
                        list.innerHTML = data.map(f => `
                            <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                                <div class="flex-1">
                                    <p class="font-semibold text-base">${f.name || 'Unknown'}</p>
                                    <p class="text-sm text-gray-600">${f.email || 'No email'}</p>
                                    ${f.phone ? `<p class="text-xs text-gray-500">${f.phone}</p>` : ''}
                                </div>
                                <button onclick="deleteFulfiller('${f.id}')" class="ml-4 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition">Delete</button>
                            </div>
                        `).join('');
                        select.innerHTML = '<option value="">Select a fulfiller...</option>' +
                            data.map(f => `<option value="${f.id}">${f.name || 'Unknown'} (${f.email || 'No email'})</option>`).join('');
                    }
                    
                    // Load completed orders
                    return adminFetch(`${BACKEND_URL}/api/admin/orders`);
                })
                .then(ordersData => {
                    if (!Array.isArray(ordersData)) {
                        throw new Error('Invalid orders data format');
                    }
                    // Filter orders that need fulfillment (pending fulfillment or fulfilled)
                    const fulfillableOrders = ordersData.filter(o => o.status === 'pending fulfillment' || o.status === 'fulfilled');
                    const orderSelect = document.getElementById('fulfiller-order-select');
                    if (orderSelect) {
                        if (fulfillableOrders.length === 0) {
                            orderSelect.innerHTML = '<option value="">No orders to fulfill</option>';
                        } else {
                            orderSelect.innerHTML = '<option value="">Select an order...</option>' +
                                fulfillableOrders.map(o => `<option value="${o.id}">${o.id} - ${o.customerName || 'Unknown'} - R${(o.total || 0).toFixed(2)} (${o.status})</option>`).join('');
                        }
                    }
                })
                .catch(err => {
                    console.error('Error loading fulfillers/orders:', err);
                    if (list) {
                        list.innerHTML = `<div class="error-message">Error loading fulfillers: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                    }
                    if (select) {
                        select.innerHTML = '<option value="">Error loading fulfillers</option>';
                    }
                    const orderSelect = document.getElementById('fulfiller-order-select');
                    if (orderSelect) {
                        orderSelect.innerHTML = '<option value="">Error loading orders</option>';
                    }
                });
        }
        
        // Auto-fill order details when order is selected
        document.getElementById('fulfiller-order-select')?.addEventListener('change', async function(e) {
            const orderId = e.target.value;
            if (!orderId) {
                document.getElementById('fulfiller-order-details').value = '';
                return;
            }
            
            try {
                const orders = await adminFetch(`${BACKEND_URL}/api/admin/orders`);
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    const itemsText = Array.isArray(order.items) ? order.items.map(item => {
                        const sizeText = item.size ? `, Size: ${item.size}` : '';
                        const colorText = item.color ? `, Color: ${item.color}` : '';
                        return `- ${item.name}${sizeText}${colorText} (Qty: ${item.quantity}) - R${(item.price * item.quantity).toFixed(2)}`;
                    }).join('\n') : 'No items';
                    
                    const orderDetails = `Order ID: ${order.id}\nCustomer: ${order.customerName || 'Unknown'}\nEmail: ${order.customerEmail || 'N/A'}\nPhone: ${order.customerPhone || 'N/A'}\n\nOrder Items:\n${itemsText}\n\nTotal: R${(order.total || 0).toFixed(2)}\nDate: ${order.date ? new Date(order.date).toLocaleString() : 'N/A'}\n\nDelivery Address: ${order.deliveryAddress || 'N/A'}`;
                    document.getElementById('fulfiller-order-details').value = orderDetails;
                }
            } catch (err) {
                console.error('Error loading order details:', err);
            }
        });

        // Functions are now defined at the top of the script (see above)

        // Set up fulfiller form event listener safely - wait for DOM to be ready
        function setupFulfillerForm() {
            const fulfillerForm = document.getElementById('add-fulfiller-form');
            if (!fulfillerForm) {
                console.warn('Fulfiller form not found when setting up event listener');
                return;
            }
            
            console.log('Setting up fulfiller form event listener');
            
            // Remove existing listener by cloning (avoids duplicates)
            const formParent = fulfillerForm.parentNode;
            const newForm = fulfillerForm.cloneNode(true);
            formParent.replaceChild(newForm, fulfillerForm);
            
            // Update IDs after cloning
            newForm.id = 'add-fulfiller-form';
            const nameInput = newForm.querySelector('#fulfiller-name');
            const emailInput = newForm.querySelector('#fulfiller-email');
            const phoneInput = newForm.querySelector('#fulfiller-phone');
            if (nameInput) nameInput.id = 'fulfiller-name';
            if (emailInput) emailInput.id = 'fulfiller-email';
            if (phoneInput) phoneInput.id = 'fulfiller-phone';
            
            newForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Fulfiller form submitted');
                    
                    // Get values from the form directly (not by ID, since form was cloned)
                    const nameInput = newForm.querySelector('#fulfiller-name') || newForm.querySelector('input[type="text"]');
                    const emailInput = newForm.querySelector('#fulfiller-email') || newForm.querySelector('input[type="email"]');
                    const phoneInput = newForm.querySelector('#fulfiller-phone') || newForm.querySelector('input[type="tel"]');
                    
                    const name = nameInput?.value.trim();
                    const email = emailInput?.value.trim();
                    const phone = phoneInput?.value.trim();
                    
                    console.log('Form values:', { name, email, phone });
                    
                    // Validate inputs
                    if (!name || !email || !phone) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    // Validate email format
                    if (!email.includes('@') || !email.includes('.')) {
                        alert('Please enter a valid email address');
                        return;
                    }

                    const submitBtn = newForm.querySelector('button[type="submit"]');
                    if (!submitBtn) {
                        console.error('Submit button not found');
                        alert('Error: Submit button not found');
                        return;
                    }
                    
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Adding...';
                    
                    console.log('Sending request to:', `${BACKEND_URL}/api/admin/fulfillers`);
                    console.log('Request body:', { name, email, phone });

                    adminFetch(`${BACKEND_URL}/api/admin/fulfillers`, {
                        method: 'POST',
                        body: JSON.stringify({ name, email, phone })
                    })
                    .then(data => {
                        console.log('Fulfiller add response:', data);
                        if (data && data.success) {
                            closeAddFulfillerModal();
                            loadFulfillers();
                            // Show success notification
                            const notification = document.createElement('div');
                            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                            notification.textContent = 'Fulfiller added successfully!';
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 3000);
                        } else {
                            const errorMsg = data?.error || 'Failed to add fulfiller';
                            console.error('Failed to add fulfiller:', errorMsg);
                            alert('Error: ' + errorMsg);
                        }
                    })
                    .catch(err => {
                        console.error('Error adding fulfiller:', err);
                        alert('Error: ' + (err.message || 'Failed to add fulfiller. Please check your connection.'));
                    })
                    .finally(() => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    });
                });
            console.log('Fulfiller form event listener set up successfully');
        }
        
        // Set up form listener when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupFulfillerForm);
        } else {
            setupFulfillerForm();
        }
        
        // Also add click handler to the button directly (as backup)
        // This ensures the button works even if onclick attribute fails
        function setupAddFulfillerButton() {
            const addFulfillerBtn = document.querySelector('button[onclick="showAddFulfillerModal()"]');
            if (addFulfillerBtn) {
                console.log('Found Add Fulfiller button, adding click handler');
                // Remove existing listeners by cloning
                const newBtn = addFulfillerBtn.cloneNode(true);
                addFulfillerBtn.parentNode.replaceChild(newBtn, addFulfillerBtn);
                
                newBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Add Fulfiller button clicked');
                    if (window.showAddFulfillerModal) {
                        window.showAddFulfillerModal();
                    } else {
                        console.error('showAddFulfillerModal function not found');
                        alert('Error: Function not available. Please refresh the page.');
                    }
                });
            } else {
                console.warn('Add Fulfiller button not found');
            }
        }
        
        // Set up button listener when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupAddFulfillerButton);
        } else {
            setupAddFulfillerButton();
        }
        

        function deleteFulfiller(id) {
            if (!confirm('Delete this fulfiller?')) return;
            adminFetch(`${BACKEND_URL}/api/admin/fulfillers/${id}`, {
                method: 'DELETE'
            })
            .then(data => {
                if (data.success) {
                    loadFulfillers();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete fulfiller'));
                }
            })
            .catch(err => {
                console.error('Error deleting fulfiller:', err);
                alert('Error: ' + err.message);
            });
        }

        document.getElementById('fulfiller-email-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const fulfillerId = document.getElementById('fulfiller-select').value;
            const orderDetails = document.getElementById('fulfiller-order-details').value;

            if (!fulfillerId || !orderDetails) {
                alert('Please select a fulfiller and enter order details');
                return;
            }

            adminFetch(`${BACKEND_URL}/api/admin/fulfillers/notify`, {
                method: 'POST',
                body: JSON.stringify({ fulfillerId, orderDetails })
            })
            .then(data => {
                if (data.success) {
                    alert('Email sent to fulfiller');
                    document.getElementById('fulfiller-email-form').reset();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send email'));
                }
            })
            .catch(err => {
                console.error('Error sending fulfiller email:', err);
                alert('Error: ' + err.message);
            });
        });

        // Notifications functions
        function loadNotifications() {
            const list = document.getElementById('notifications-list');
            if (!list) return;
            
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading notifications...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/notifications`)
                .then(data => {
                    console.log('Notifications data received:', data);
                    if (!data) {
                        throw new Error('No data received from server');
                    }
                    if (!Array.isArray(data)) {
                        // If it's an error object, throw it
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        throw new Error('Invalid data format - expected array');
                    }
                    if (data.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No notifications</div>';
                        return;
                    }
                    list.innerHTML = data.map(notif => {
                        const notifId = notif.id || Date.now().toString();
                        const notifTitle = (notif.title || 'Notification').replace(/'/g, "\\'");
                        const notifMessage = (notif.message || 'No message').replace(/'/g, "\\'");
                        return `
                        <div class="border border-gray-200 rounded-lg p-4 ${notif.read ? 'bg-gray-50' : 'bg-white'}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold">${notifTitle}</p>
                                    <p class="text-sm text-gray-600">${notifMessage}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-500">${notif.date ? new Date(notif.date).toLocaleString() : 'N/A'}</span>
                                    ${!notif.read ? `<button onclick="markNotificationRead('${notifId}')" class="ml-2 text-sm text-blue-600 hover:underline">Mark Read</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Error loading notifications:', err);
                    const errorMsg = err.message || 'Unknown error';
                    list.innerHTML = `<div class="error-message">Error loading notifications: ${errorMsg}<br><small>Backend URL: ${BACKEND_URL}</small><br><small>Please check your connection and ensure the backend is running.</small></div>`;
                });
        }

        function markNotificationRead(notifId) {
            adminFetch(`${BACKEND_URL}/api/admin/notifications/read`, {
                method: 'POST',
                body: JSON.stringify({ notificationId: notifId })
            })
            .then(data => {
                if (data.success) {
                    loadNotifications();
                    // Update badges immediately
                    updateBadges();
                    // Also update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        loadDashboardData();
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark notification as read'));
                }
            })
            .catch(err => {
                console.error('Error marking notification as read:', err);
                alert('Error: ' + err.message);
            });
        }

        function markAllRead() {
            adminFetch(`${BACKEND_URL}/api/admin/notifications/read-all`, {
                method: 'POST'
            })
            .then(data => {
                if (data.success) {
                    loadNotifications();
                    // Update badges immediately
                    updateBadges();
                    // Also update dashboard stats if on dashboard
                    if (currentSection === 'dashboard') {
                        loadDashboardData();
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to mark all as read'));
                }
            })
            .catch(err => {
                console.error('Error marking all as read:', err);
                alert('Error: ' + err.message);
            });
        }

        function refreshNotifications() {
            loadNotifications();
        }

        // Orders Management functions
        // allOrdersData is declared at the top of the script
        
        function loadOrders() {
            const tbody = document.getElementById('orders-table');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-12 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading orders...</span></div></td></tr>';
            }
            
            adminFetch(`${BACKEND_URL}/api/admin/orders`)
                .then(data => {
                    console.log('Orders data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    allOrdersData = data;
                    renderOrders(data);
                })
                .catch(err => {
                    console.error('Error loading orders:', err);
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-12"><div class="error-message">Error loading orders: ${err.message}</div></td></tr>`;
                    }
                });
        }
        
        function renderOrders(orders) {
            const tbody = document.getElementById('orders-table');
            const mobileTable = document.getElementById('orders-table-mobile');
            
            if (!tbody) return;
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-12 text-gray-500">No orders found</td></tr>';
                if (mobileTable) {
                    mobileTable.innerHTML = '<div class="text-center py-12 text-gray-500">No orders found</div>';
                }
                return;
            }
            
            // Desktop table
            tbody.innerHTML = orders.map(order => {
                const itemCount = Array.isArray(order.items) ? order.items.length : 0;
                let statusClass = 'bg-yellow-100 text-yellow-800';
                if (order.status === 'fulfilled') {
                    statusClass = 'bg-green-100 text-green-800';
                } else if (order.status === 'pending fulfillment') {
                    statusClass = 'bg-blue-100 text-blue-800';
                } else if (order.status === 'pending checkout') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-mono text-sm">${order.id || 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <div>
                                <p class="font-semibold">${order.customerName || 'Unknown'}</p>
                                <p class="text-xs text-gray-500">${order.customerEmail || ''}</p>
                            </div>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${itemCount} items</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-semibold">R${(order.total || 0).toFixed(2)}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="font-semibold text-sm">${order.deliveryCost !== undefined && order.deliveryCost !== null ? 'R' + (order.deliveryCost || 0).toFixed(2) : 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${order.status || 'pending checkout'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <span class="text-sm text-gray-600">${order.date ? new Date(order.date).toLocaleDateString() : 'N/A'}</span>
                        </td>
                        <td class="py-4 px-4 md:px-6">
                            <select onchange="updateOrderStatus('${order.id}', this.value)" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                                <option value="pending checkout" ${order.status === 'pending checkout' ? 'selected' : ''}>Pending Checkout</option>
                                <option value="pending fulfillment" ${order.status === 'pending fulfillment' ? 'selected' : ''}>Pending Fulfillment</option>
                                <option value="fulfilled" ${order.status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Mobile cards
            if (mobileTable) {
                mobileTable.innerHTML = orders.map(order => {
                    const itemCount = Array.isArray(order.items) ? order.items.length : 0;
                    let statusClass = 'bg-yellow-100 text-yellow-800';
                    if (order.status === 'fulfilled') {
                        statusClass = 'bg-green-100 text-green-800';
                    } else if (order.status === 'pending fulfillment') {
                        statusClass = 'bg-blue-100 text-blue-800';
                    } else if (order.status === 'pending checkout') {
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    }
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-semibold text-sm">${order.customerName || 'Unknown'}</p>
                                    <p class="text-xs text-gray-500">${order.customerEmail || ''}</p>
                                    <p class="text-xs font-mono text-gray-400 mt-1">${order.id || 'N/A'}</p>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${order.status || 'pending checkout'}</span>
                            </div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-600">${itemCount} items</span>
                                <span class="font-semibold">R${(order.total || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">${order.date ? new Date(order.date).toLocaleDateString() : 'N/A'}</span>
                                <select onchange="updateOrderStatus('${order.id}', this.value)" class="px-2 py-1 border border-gray-300 rounded-lg text-xs">
                                    <option value="pending checkout" ${order.status === 'pending checkout' ? 'selected' : ''}>Pending Checkout</option>
                                    <option value="pending fulfillment" ${order.status === 'pending fulfillment' ? 'selected' : ''}>Pending Fulfillment</option>
                                    <option value="fulfilled" ${order.status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
                                </select>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function updateOrderStatus(orderId, status) {
            // Check if changing from pending fulfillment to fulfilled - require delivery cost
            const order = allOrdersData.find(o => o.id === orderId);
            if (order && order.status === 'pending fulfillment' && status === 'fulfilled') {
                const deliveryCost = prompt('Enter delivery cost for this order (R):');
                if (deliveryCost === null) {
                    // User cancelled, reset dropdown
                    loadOrders();
                    return;
                }
                const deliveryCostNum = parseFloat(deliveryCost);
                if (isNaN(deliveryCostNum) || deliveryCostNum < 0) {
                    alert('Please enter a valid delivery cost (number >= 0)');
                    loadOrders();
                    return;
                }
                
                adminFetch(`${BACKEND_URL}/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status, deliveryCost: deliveryCostNum })
                })
                .then(data => {
                    if (data.success) {
                        loadOrders();
                        if (currentSection === 'dashboard') loadDashboardData();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update order status'));
                        loadOrders();
                    }
                })
                .catch(err => {
                    console.error('Error updating order status:', err);
                    alert('Error: ' + err.message);
                    loadOrders();
                });
            } else {
                adminFetch(`${BACKEND_URL}/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                })
                .then(data => {
                    if (data.success) {
                        loadOrders();
                        if (currentSection === 'dashboard') loadDashboardData();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to update order status'));
                    }
                })
                .catch(err => {
                    console.error('Error updating order status:', err);
                    alert('Error: ' + err.message);
                });
            }
        }
        
        function refreshOrders() {
            loadOrders();
        }
        
        // Search and filter orders
        document.getElementById('orders-search')?.addEventListener('input', (e) => {
            // Only filter if data is loaded
            if (allOrdersData && allOrdersData.length > 0) {
            const searchTerm = e.target.value.toLowerCase();
            const status = document.getElementById('orders-filter-status')?.value || '';
            filterOrders(searchTerm, status);
            }
        });
        
        document.getElementById('orders-filter-status')?.addEventListener('change', (e) => {
            // Only filter if data is loaded
            if (allOrdersData && allOrdersData.length > 0) {
            const searchTerm = document.getElementById('orders-search')?.value.toLowerCase() || '';
            filterOrders(searchTerm, e.target.value);
            }
        });
        
        function filterOrders(searchTerm, status) {
            // Ensure allOrdersData is initialized
            if (!allOrdersData || !Array.isArray(allOrdersData)) {
                allOrdersData = [];
            }
            
            let filtered = [...allOrdersData]; // Create a copy to avoid mutation
            
            if (searchTerm) {
                filtered = filtered.filter(order => 
                    (order.customerName || '').toLowerCase().includes(searchTerm) ||
                    (order.customerEmail || '').toLowerCase().includes(searchTerm) ||
                    (order.id || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (status) {
                filtered = filtered.filter(order => (order.status || '') === status);
            }
            
            renderOrders(filtered);
        }

        // Analytics functions
        function loadAnalytics() {
            adminFetch(`${BACKEND_URL}/api/admin/dashboard`)
                .then(data => {
                    if (data.success) {
                        // Render revenue chart
                        renderRevenueChart(data.monthlyRevenue);
                        // Render status chart
                        renderStatusChart(data.stats);
                        // Render sales summary
                        renderSalesSummary(data);
                    }
                })
                .catch(err => {
                    console.error('Error loading analytics:', err);
                    document.getElementById('revenue-chart').innerHTML = `<div class="error-message">Error loading analytics: ${err.message}</div>`;
                });
        }
        
        function renderRevenueChart(monthlyRevenue) {
            const container = document.getElementById('revenue-chart');
            if (!container) return;
            
            const months = Object.keys(monthlyRevenue).sort();
            const values = months.map(m => monthlyRevenue[m]);
            const maxValue = Math.max(...values, 1);
            
            container.innerHTML = `
                <div class="w-full h-full flex items-end justify-between space-x-2">
                    ${months.map((month, i) => {
                        const height = (values[i] / maxValue) * 100;
                        const monthLabel = new Date(month + '-01').toLocaleDateString('en-US', { month: 'short' });
                        return `
                            <div class="flex-1 flex flex-col items-center">
                                <div class="w-full bg-gray-200 rounded-t" style="height: ${height}%; min-height: 20px;">
                                    <div class="w-full h-full bg-black rounded-t transition-all duration-300"></div>
                                </div>
                                <p class="text-xs text-gray-600 mt-2">${monthLabel}</p>
                                <p class="text-xs font-semibold mt-1">R${values[i].toFixed(0)}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderStatusChart(stats) {
            const container = document.getElementById('status-chart');
            if (!container) return;
            
            const total = stats.totalOrders || 1;
            const completedPercent = ((stats.completedOrders || 0) / total) * 100;
            const pendingPercent = ((stats.pendingOrders || 0) / total) * 100;
            
            container.innerHTML = `
                <div class="w-full space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Completed</span>
                            <span class="text-sm font-semibold">${stats.completedOrders || 0} (${completedPercent.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: ${completedPercent}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Pending</span>
                            <span class="text-sm font-semibold">${stats.pendingOrders || 0} (${pendingPercent.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-yellow-600 h-4 rounded-full transition-all duration-300" style="width: ${pendingPercent}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSalesSummary(data) {
            const container = document.getElementById('sales-summary');
            if (!container) return;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Total Revenue</p>
                        <p class="text-2xl font-bold">R${(data.stats.totalRevenue || 0).toFixed(2)}</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Total Profit</p>
                        <p class="text-2xl font-bold text-green-600">R${(data.stats.totalProfit || 0).toFixed(2)}</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Total Costs</p>
                        <p class="text-2xl font-bold text-red-600">R${(data.stats.totalCosts || 0).toFixed(2)}</p>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-2">Average Order Value</p>
                        <p class="text-2xl font-bold">R${data.stats.totalOrders > 0 ? (data.stats.totalRevenue / data.stats.totalOrders).toFixed(2) : '0.00'}</p>
                    </div>
                </div>
            `;
        }

        // Sales/POS functions
        function loadSales() {
            const container = document.getElementById('pos-products');
                    container.innerHTML = '<div class="col-span-2 md:col-span-3 lg:col-span-4 text-center py-8 text-gray-500"><div class="flex items-center justify-center space-x-2"><div class="loading-spinner"></div><span>Loading products...</span></div></div>';
            
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(data => {
                    console.log('POS products data received:', data);
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid products data format');
                    }
                    if (data.length === 0) {
                        container.innerHTML = '<div class="col-span-2 md:col-span-3 lg:col-span-4 text-center py-8 text-gray-500">No products available</div>';
                        return;
                    }
                    container.innerHTML = data.map(p => {
                        const firstImage = p.images && p.images.length > 0 ? p.images[0] : (p.availableColors && p.availableColors.length > 0 ? p.availableColors[0].image : 'https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1');
                        const hasVariants = (p.sizes && p.sizes.length > 1) || (p.colors && p.colors.length > 1);
                        return `
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-200 bg-white">
                            <div class="aspect-square mb-3 bg-gray-100 rounded-lg overflow-hidden">
                                <img src="${firstImage}" alt="${p.name}" class="w-full h-full object-cover" onerror="this.src='https://dl.dropboxusercontent.com/scl/fi/pew6zj6bt0myobu7zl4eu/1-21.png?rlkey=z6jhjxe71rpuk37td9ktwvqmg&st=303hz8tw&dl=1'">
                            </div>
                            <p class="font-semibold text-sm md:text-base mb-1">${p.name || 'Unknown Product'}</p>
                            <p class="text-gray-600 text-sm md:text-base font-bold mb-2">R${(p.price || 0).toFixed(2)}</p>
                            ${hasVariants ? `
                                <button onclick="showVariantModal(${p.id})" class="w-full px-3 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition">Select Variant</button>
                            ` : `
                                <button onclick="addToPOSCart(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price || 0}, null, null)" class="w-full px-3 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition">Add to Cart</button>
                            `}
                        </div>
                    `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Error loading POS products:', err);
                    container.innerHTML = `<div class="col-span-2 md:col-span-3 lg:col-span-4 error-message">Error loading products: ${err.message}<br><small>Backend URL: ${BACKEND_URL}</small></div>`;
                });
        }

        function showVariantModal(productId) {
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(data => {
                    const product = data.find(p => p.id === productId);
                    if (!product) return;
                    
                    let modalHtml = `
                        <div id="variant-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                                <h3 class="text-xl font-bold mb-4">${product.name}</h3>
                                <div class="space-y-4">
                    `;
                    
                    if (product.sizes && product.sizes.length > 1) {
                        modalHtml += `
                            <div>
                                <label class="block text-sm font-medium mb-2">Size</label>
                                <select id="variant-size" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    ${product.sizes.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    }
                    
                    if (product.colors && product.colors.length > 1) {
                        modalHtml += `
                            <div>
                                <label class="block text-sm font-medium mb-2">Color</label>
                                <select id="variant-color" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    ${product.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    }
                    
                    modalHtml += `
                                    <div class="flex space-x-2">
                                        <button onclick="addToPOSCartWithVariant(${productId})" class="flex-1 px-4 py-2 bg-black text-white rounded-lg font-medium hover:bg-gray-800">Add to Cart</button>
                                        <button onclick="closeVariantModal()" class="flex-1 px-4 py-2 bg-gray-300 text-black rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                });
        }

        function closeVariantModal() {
            const modal = document.getElementById('variant-modal');
            if (modal) modal.remove();
        }

        function addToPOSCartWithVariant(productId) {
            adminFetch(`${BACKEND_URL}/api/admin/products`)
                .then(data => {
                    const product = data.find(p => p.id === productId);
                    if (!product) return;
                    
                    const size = document.getElementById('variant-size')?.value || (product.sizes && product.sizes.length === 1 ? product.sizes[0] : null);
                    const color = document.getElementById('variant-color')?.value || (product.colors && product.colors.length === 1 ? product.colors[0] : null);
                    
                    addToPOSCart(productId, product.name, product.price, size, color);
                    closeVariantModal();
                });
        }

        function addToPOSCart(id, name, price, size, color) {
            const variantKey = `${id}-${size || 'default'}-${color || 'default'}`;
            const existing = posCart.find(item => item.variantKey === variantKey);
            if (existing) {
                existing.quantity++;
            } else {
                posCart.push({ 
                    id, 
                    name, 
                    price, 
                    quantity: 1,
                    size: size || null,
                    color: color || null,
                    variantKey: variantKey
                });
            }
            updatePOSCart();
        }

        function updatePOSCart() {
            const container = document.getElementById('pos-cart');
            if (posCart.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No items added</p>';
                document.getElementById('pos-total').textContent = 'R0.00';
                return;
            }
            container.innerHTML = posCart.map((item, index) => `
                <div class="flex justify-between items-center p-3 border border-gray-200 rounded-lg bg-white hover:shadow-md transition">
                    <div class="flex-1">
                        <p class="font-semibold text-sm">${item.name}</p>
                        ${item.size || item.color ? `<p class="text-xs text-gray-500">${[item.size, item.color].filter(Boolean).join(' / ')}</p>` : ''}
                        <p class="text-sm text-gray-600 mt-1">R${item.price.toFixed(2)} √ó ${item.quantity} = R${(item.price * item.quantity).toFixed(2)}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updatePOSQuantity(${index}, -1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">-</button>
                        <span class="font-semibold min-w-[2rem] text-center">${item.quantity}</span>
                        <button onclick="updatePOSQuantity(${index}, 1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">+</button>
                        <button onclick="removeFromPOSCart(${index})" class="ml-2 px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">Remove</button>
                    </div>
                </div>
            `).join('');
            const total = posCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('pos-total').textContent = 'R' + total.toFixed(2);
        }

        function updatePOSQuantity(index, change) {
            const item = posCart[index];
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    posCart.splice(index, 1);
                }
                updatePOSCart();
            }
        }

        function removeFromPOSCart(index) {
            posCart.splice(index, 1);
            updatePOSCart();
        }

        document.getElementById('pos-order-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (posCart.length === 0) {
                alert('Please add items to cart');
                return;
            }
            const customerName = document.getElementById('pos-customer-name').value;
            const customerEmail = document.getElementById('pos-customer-email').value;
            const customerPhone = document.getElementById('pos-customer-phone').value;
            const paymentMethod = document.getElementById('pos-payment-method').value;
            const total = posCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            adminFetch(`${BACKEND_URL}/api/admin/pos/order`, {
                method: 'POST',
                body: JSON.stringify({
                    customerName,
                    customerEmail,
                    customerPhone,
                    paymentMethod,
                    items: posCart,
                    total
                })
            })
            .then(data => {
                console.log('POS order response:', data);
                if (data.success) {
                    alert('Order created successfully');
                    posCart = [];
                    updatePOSCart();
                    document.getElementById('pos-order-form').reset();
                    if (paymentMethod === 'yoco' && data.paymentUrl) {
                        // Redirect to Yoco checkout
                        window.location.href = data.paymentUrl;
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to create order'));
                }
            })
            .catch(err => {
                console.error('Error creating POS order:', err);
                alert('Error creating order: ' + err.message);
            });
        });
    </script>
</body>
</html>

